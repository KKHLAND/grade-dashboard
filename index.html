<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>내신 성적 분석 대시보드 (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', 'Pretendard', sans-serif; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    
        .file-upload-area { border: 2px dashed #cbd5e1; transition: all 0.2s; }
        .file-upload-area:hover { border-color: #0ea5e9; background-color: #f0f9ff; }
        .file-upload-area.dragging { border-color: #0ea5e9; background-color: #e0f2fe; }
</style>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 text-slate-800 antialiased min-h-screen p-6 md:p-8">
    
    <div id="app" class="w-full max-w-screen-2xl mx-auto">
        
        <header class="bg-white p-8 px-8 rounded-xl shadow-lg flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-slate-800">내신 성적 분석 대시보드 (Pro)</h1>
                    <p class="text-lg text-slate-500">AI 기반 성적 분석 및 리포트 도구</p>
                </div>
            </div>
            <button class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3.5a1.5 1.5 0 01.782 2.845 1.5 1.5 0 01-1.564 0A1.5 1.5 0 0110 3.5zM6.5 6.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3zM13.5 6.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3zM10 13.5a1.5 1.5 0 01.782 2.845 1.5 1.5 0 01-1.564 0A1.5 1.5 0 0110 13.5zM6.5 10.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3zM13.5 10.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3z"/></svg>
                AI Powered
            </button>
        </header>

        <div class="flex flex-col md:flex-row gap-6">

            <aside id="sidebar" class="bg-white w-full md:w-96 rounded-xl shadow-lg flex-shrink-0 flex flex-col">
                <div id="sidebar-content" class="flex-grow overflow-y-auto p-6 space-y-6"></div>
            </aside>

            <div class="flex-1 flex flex-col bg-white rounded-xl shadow-lg overflow-hidden">
                <main id="dashboard-container" class="flex-1 overflow-y-auto p-6 lg:p-8">
                    </main>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONSTANTS AND STATE ---
    const CONSTANTS = { GRADE_TIERS_9: { 1: 4, 2: 11, 3: 23, 4: 40, 5: 60, 6: 77, 7: 89, 8: 96, 9: 100 }, GRADES_9_TIER: [1, 2, 3, 4, 5, 6, 7, 8, 9], GRADE_TIERS_5: { 1: 10, 2: 34, 3: 66, 4: 90, 5: 100 }, GRADES_5_TIER: [1, 2, 3, 4, 5], 
        DEFAULT_ACHIEVEMENT_CUTOFFS_9_TIER: { A: 85, B: 70, C: 55, D: 40, E: 0 },
        DEFAULT_ACHIEVEMENT_CUTOFFS_5_TIER: { A: 85, B: 70, C: 60, D: 45, E: 30, I: 0 }, 
        FILE_METADATA: { roster: { name: '명렬표', label: '명렬표' }, midterm: { name: '중간', label: '중간고사' }, final: { name: '기말', label: '기말고사' }, performance: { name: '수행', label: '수행평가' } }, TABS: { midterm: '중간고사', final: '기말고사', total: '합산 점수' }, TABS_ORDER: ['midterm', 'final', 'total'] };
    
    let state = { files: {}, excelFiles: {}, logoSrc: null, academicInfo: { year: new Date().getFullYear(), semester: 1, grade: 1, subject: '' }, analysisSettings: { weights: { midterm: 30, final: 30, performance: 40 }, gradingSystem: 'relative', gradeTiers: 9, 
        achievementCutoffs9Tier: { midterm: {...CONSTANTS.DEFAULT_ACHIEVEMENT_CUTOFFS_9_TIER}, final: {...CONSTANTS.DEFAULT_ACHIEVEMENT_CUTOFFS_9_TIER}, total: {...CONSTANTS.DEFAULT_ACHIEVEMENT_CUTOFFS_9_TIER} },
        achievementCutoffs5Tier: { midterm: {...CONSTANTS.DEFAULT_ACHIEVEMENT_CUTOFFS_5_TIER}, final: {...CONSTANTS.DEFAULT_ACHIEVEMENT_CUTOFFS_5_TIER}, total: {...CONSTANTS.DEFAULT_ACHIEVEMENT_CUTOFFS_5_TIER} }
    }, filters: { classes: [], grades: [] }, activeStatTab: 'midterm', allStudents: [], classList: [], analysisError: null, isProcessing: false, isReady: false, sortConfig: { key: 'ranks.midterm', direction: 'asc' } };
    
    const DOMElements = { 
        sidebarContent: document.getElementById('sidebar-content'),
        academicInfoContainer: document.getElementById('academic-info-container'), 
        logoContainer: document.getElementById('logo-container'), 
        dashboardContainer: document.getElementById('dashboard-container'),
        sidebar: document.getElementById('sidebar'),
    };
    let pieChartInstance = null, barChartInstance = null;

    // --- RENDER FUNCTIONS ---
    function render() {
        renderSidebar();
        renderDashboard(); 
    }
    
    function renderSidebar() {
        const { files, analysisSettings: s, filters, classList, isReady, activeStatTab, academicInfo } = state;
        const totalWeight = Object.values(s.weights).reduce((sum, v) => sum + v, 0);
        
        const is9Tier = s.gradeTiers === 9;
        const activeColor = is9Tier ? 'green' : 'indigo';
        const activeBgClass = `bg-${activeColor}-600`;
        const activeTextClass = `text-${activeColor}-600`;
        const focusRingClass = `peer-focus:ring-${activeColor}-300`;
        const lightBgClass = `bg-${activeColor}-50`;
        const lightBorderClass = `border-${activeColor}-200`;
        const lightTextClass = `text-${activeColor}-800`;

        const infoBadges = [
            { label: '학년도', value: academicInfo.year, color: 'indigo' },
            { label: '학기', value: academicInfo.semester + '학기', color: 'cyan' },
            { label: '학년', value: academicInfo.grade + '학년', color: 'green' },
            { label: '과목', value: academicInfo.subject || '미추출', color: 'purple' }
        ];
        
        const academicInfoHTML = `
            <div class="space-y-2">
                <div class="flex flex-wrap gap-2">
                    ${infoBadges.map(badge => `
                        <span class="px-2.5 py-0.5 bg-${badge.color}-100 text-${badge.color}-800 rounded-full text-xs font-semibold">
                            ${badge.label}: ${badge.value}
                        </span>
                    `).join('')}
                </div>
            </div>`;


        const fileUploadHTML = `<div class="space-y-3">
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800 mb-3">
                <p class="font-semibold mb-1">📋 명렬표 CSV 업로드 (필수)</p>
                <p class="text-xs">명렬표는 반드시 CSV 파일로 업로드해야 합니다.</p>
            </div>
            <label for="file-upload" class="cursor-pointer group">
                <div class="flex flex-col items-center justify-center border-2 border-dashed border-slate-300 rounded-lg p-6 text-center bg-white group-hover:border-${activeColor}-500 transition-colors">
                    <svg class="w-10 h-10 text-slate-400 group-hover:text-${activeColor}-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                    <p class="mt-2 font-semibold">명렬표 파일 선택 또는 드래그</p>
                    <p class="text-sm text-slate-500">.csv 파일만 가능</p>
                </div>
                <input id="file-upload" type="file" accept=".csv" class="hidden">
            </label>
            ${files.roster ? `
                <div class="flex items-center gap-2 p-3 rounded-md bg-green-100 text-green-700">
                    <svg viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                    <span class="font-medium">명렬표: ${files.roster.name}</span>
                </div>
            ` : `
                <div class="flex items-center gap-2 p-3 rounded-md bg-slate-100 text-slate-500">
                    <div class="w-5 h-5 border-2 border-slate-400 rounded-full"></div>
                    <span>명렬표 (필수)</span>
                </div>
            `}
            <div class="text-xs text-slate-600 space-y-1 bg-slate-50 p-3 rounded-md border border-slate-200">
                <p class="font-semibold">CSV 파일 형식:</p>
                <ol class="list-decimal list-inside space-y-1">
                    <li>파일은 <strong>CSV (UTF-8)</strong> 형식이어야 합니다.</li>
                    <li>파일 이름에 <strong>'명렬표'</strong>가 포함되어야 합니다.</li>
                </ol>
            </div>
        </div>`;

        const excelUploadHTML = `<div class="space-y-3">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800">
                <p class="font-semibold mb-1">💡 나이스 엑셀 업로드 방법</p>
                <ul class="text-xs space-y-1">
                    <li>• 나이스에서 다운로드한 엑셀 파일을 그대로 업로드</li>
                    <li>• 학년도, 학기, 학년, 과목이 <strong>자동으로 추출</strong>됩니다</li>
                    <li>• 중간고사, 기말고사, 수행평가 각각 업로드</li>
                </ul>
            </div>
            ${['midterm', 'final'].map(type => {
                const hasFile = !!state.excelFiles[type];
                const fileName = hasFile ? state.excelFiles[type].name : '';
                const label = {midterm:'중간고사', final:'기말고사'}[type];
                return `<div class="file-upload-area rounded-lg p-4 cursor-pointer" onclick="document.getElementById('excel-${type}').click()">
                    <input id="excel-${type}" type="file" accept=".xlsx,.xls" class="hidden" onchange="handleExcelFileSelect(event, '${type}')">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                        <div class="flex-1">
                            ${hasFile ? `<p class="text-sm font-medium text-slate-800">${fileName}</p><p class="text-xs text-green-600">✓ 업로드 완료</p>` : `<p class="text-sm text-slate-600">${label} (.xlsx, .xls)</p><p class="text-xs text-slate-400">클릭하여 파일 선택</p>`}
                        </div>
                        ${hasFile ? `<button onclick="event.stopPropagation(); removeExcelFile('${type}')" class="text-red-500 hover:text-red-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>` : ''}
                    </div>
                </div>`;
            }).join('')}
            
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-sm text-slate-800">수행평가 (여러 파일 가능)</h3>
                    <button onclick="document.getElementById('excel-performance-files-multi').click()" class="text-xs bg-indigo-600 text-white px-2 py-1 rounded hover:bg-indigo-700">+ 추가</button>
                    <input id="excel-performance-files-multi" type="file" accept=".xlsx,.xls" multiple class="hidden" onchange="handleMultiplePerformanceFiles(event)">
                </div>
                <div id="performance-files-container" class="space-y-2">
                    ${Object.keys(state.excelFiles)
                        .filter(key => key.startsWith('performance'))
                        .sort((a, b) => {
                            const numA = parseInt(a.replace('performance', '')) || 1;
                            const numB = parseInt(b.replace('performance', '')) || 1;
                            return numA - numB;
                        })
                        .map(type => {
                            const hasFile = !!state.excelFiles[type];
                            const fileName = hasFile ? state.excelFiles[type].name : '';
                            const perfNum = type === 'performance' ? '1' : (type.replace('performance', '') || '1');
                            return `<div class="file-upload-area rounded-lg p-3 cursor-pointer">
                                <div class="flex items-center gap-3">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                                    <div class="flex-1">
                                        ${hasFile ? `<p class="text-xs font-medium text-slate-800">${perfNum}차: ${fileName}</p><p class="text-xs text-green-600">✓ 업로드 완료</p>` : `<p class="text-xs text-slate-600">수행평가 ${perfNum}차 (.xlsx, .xls)</p><p class="text-xs text-slate-400">클릭하여 파일 선택</p>`}
                                    </div>
                                    <button onclick="event.stopPropagation(); removeExcelFile('${type}')" class="text-red-500 hover:text-red-700"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                                </div>
                            </div>`;
                        }).join('')}
                </div>
            </div>
        </div>`;

        const weightsHTML = `<div class="space-y-4">${Object.keys(s.weights).map(k => `<div><div class="flex justify-between mb-1"><label class="font-medium text-sm">${{midterm:"중간고사",final:"기말고사",performance:"수행평가"}[k]}</label><div class="flex items-center"><input type="number" min="0" max="100" value="${s.weights[k]}" onchange="window.handleWeightChange('${k}',this.value)" class="w-16 p-1 bg-white border border-slate-300 rounded-md text-center text-sm"><span class="ml-2 font-semibold">%</span></div></div><input type="range" min="0" max="100" value="${s.weights[k]}" oninput="window.handleWeightChange('${k}',this.value)" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"></div>`).join('')}${totalWeight!==100?`<p class="text-xs text-center p-2 rounded-md ${totalWeight>100?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}">총합은 100%여야 합니다. (현재: ${totalWeight}%)</p>`:''}</div>`;

        const gradeTierToggleHTML = `<div class="flex items-center justify-center gap-3">
            <span class="font-semibold text-sm ${is9Tier ? 'text-green-600' : 'text-slate-400'}">9 등급제</span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" class="sr-only peer" onchange="window.handleSettingsChange('gradeTiers', this.checked ? 5 : 9)" ${s.gradeTiers === 5 ? 'checked' : ''}>
                <div class="w-11 h-6 ${is9Tier ? 'bg-green-600' : 'bg-indigo-600'} rounded-full peer peer-focus:ring-4 ${is9Tier ? 'peer-focus:ring-green-300' : 'peer-focus:ring-indigo-300'} after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full after:border-white"></div>
            </label>
            <span class="font-semibold text-sm ${!is9Tier ? 'text-indigo-600' : 'text-slate-400'}">5 등급제</span>
        </div>`;
        
        const currentCutoffs = s.gradeTiers === 9 ? s.achievementCutoffs9Tier[activeStatTab] : s.achievementCutoffs5Tier[activeStatTab];
        const cutoffsHTML = Object.entries(currentCutoffs).sort(([a],[b]) => a.localeCompare(b)).map(([l, v]) => {
            const isLocked = (s.gradeTiers === 9 && l === 'E') || (s.gradeTiers === 5 && l === 'I');
            return `<div><label class="font-bold text-sm ${l==='I'?'text-red-500':'text-slate-500'}">${l}</label><input type="number" step="0.01" value="${isLocked?0:v}" onchange="window.handleCutoffChange('${l}', this.value)" class="w-full mt-1 p-1 bg-white border border-slate-300 rounded-md text-center text-sm ${isLocked?'cursor-not-allowed opacity-60':''}" ${isLocked?'disabled':''}></div>`;
        }).join('');

        const analysisSettingsHTML = `<div class="space-y-4">
            ${gradeTierToggleHTML}
            <div class="grid grid-cols-2 gap-2 text-sm">
                <button onclick="window.handleSettingsChange('gradingSystem','relative')" class="py-2 font-semibold rounded-md transition-colors ${s.gradingSystem==='relative'?`${activeBgClass} text-white`:'bg-white border hover:bg-slate-100'}">상대평가 (등급)</button>
                <button onclick="window.handleSettingsChange('gradingSystem','absolute')" class="py-2 font-semibold rounded-md transition-colors ${s.gradingSystem==='absolute'?`${activeBgClass} text-white`:'bg-white border hover:bg-slate-100'}">성취도(분할점수)</button>
            </div>
            ${s.gradingSystem==='absolute'?`<div class="space-y-2 p-3 ${lightBgClass} ${lightBorderClass} rounded-lg pt-4"><p class="font-medium ${lightTextClass} text-center text-sm">성취도 분할 점수 (${CONSTANTS.TABS[activeStatTab]})</p><div class="grid grid-cols-3 gap-2 mt-2">${cutoffsHTML}</div></div>`:''}
        </div>`;

        const gradeOpts = s.gradingSystem === 'relative' ? (s.gradeTiers === 9 ? CONSTANTS.GRADES_9_TIER.map(String) : CONSTANTS.GRADES_5_TIER.map(String)) : Object.keys(currentCutoffs);
        const classFilterHTML=classList.map(c=>`<button onclick="window.handleFilterChange('classes','${c}')" class="px-2 py-1 text-sm rounded-md transition-colors ${filters.classes.includes(c)?`${activeBgClass} text-white font-semibold`:'bg-white border hover:bg-slate-100'}">${c}</button>`).join('');
        const gradeFilterHTML=gradeOpts.map(g=>`<button onclick="window.handleFilterChange('grades','${g}')" class="px-2 py-1 text-sm rounded-md transition-colors ${filters.grades.includes(g)?`${activeBgClass} text-white font-semibold`:`bg-white border hover:bg-slate-100 ${g==='I'?'text-red-500 font-bold':''}`}">${g}</button>`).join('');
        const filtersHTML = isReady ? `<div class="space-y-4"><div class="space-y-2">
            <div class="flex justify-between items-center"><h3 class="font-semibold text-sm">학급</h3><button onclick="window.handleSelectAll('classes')" class="text-xs ${activeTextClass} hover:underline">${filters.classes.length===classList.length?'전체해제':'전체선택'}</button></div>
            <div class="grid grid-cols-4 gap-2">${classFilterHTML}</div></div><div class="space-y-2">
            <div class="flex justify-between items-center"><h3 class="font-semibold text-sm">${s.gradingSystem==='relative'?'등급':'성취도'}</h3><button onclick="window.handleSelectAll('grades')" class="text-xs ${activeTextClass} hover:underline">${filters.grades.length===gradeOpts.length?'전체해제':'전체선택'}</button></div>
            <div class="grid grid-cols-5 gap-2">${gradeFilterHTML}</div></div></div>` : `<div class="flex flex-col items-center justify-center rounded-lg p-6 text-center bg-white border">
            <svg class="h-8 w-8 text-slate-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3-7.5 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"/></svg>
            <p class="font-medium text-sm">데이터 필터</p><p class="text-xs text-slate-500 mt-1">데이터가 로드되면 활성화됩니다.</p></div>`;

        const sidebarSections = [
            { title: '📊 자동 추출 정보', content: academicInfoHTML },
            { title: '📋 명렬표 CSV 업로드 (필수)', content: fileUploadHTML },
            { title: '📊 성적 엑셀 업로드 (나이스)', content: excelUploadHTML },
            { title: '⚙️ 반영 비율 설정', content: weightsHTML },
            { title: '📈 분석 설정', content: analysisSettingsHTML },
            { title: '🔍 동적 필터', content: filtersHTML },
        ];
        
        DOMElements.sidebarContent.innerHTML = sidebarSections.map(section => `
            <div>
                <h2 class="text-base font-semibold text-slate-900 mb-4">${section.title}</h2>
                ${section.content}
            </div>
        `).join('');

        document.getElementById('file-upload').addEventListener('change', window.handleFileChange);
        setupDropzoneEventListeners();
    }
    
    function renderDashboard() {
        const dashboardContainer = DOMElements.dashboardContainer;
        if (state.isProcessing) {
            dashboardContainer.innerHTML = `<div class="flex flex-col justify-center items-center h-full"><div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div><p class="text-lg text-slate-500 mt-4">데이터 분석 중...</p></div>`;
        } else if (state.analysisError) {
            dashboardContainer.innerHTML = `<div class="flex flex-col justify-center items-center h-full bg-red-50 rounded-xl p-4 text-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="text-xl font-bold text-red-700">분석 중 오류가 발생했습니다</p><p class="text-md text-red-600 mt-2">${state.analysisError}</p><p class="text-sm text-slate-500 mt-4">F12를 눌러 개발자 도구의 'Console' 탭에서 자세한 오류를 확인해주세요.</p></div>`;
        } else if (state.isReady) {
            const { allStudents, activeStatTab, logoSrc } = state; 
            const stats = calculateStats(allStudents, activeStatTab);

            const tabsHTML = CONSTANTS.TABS_ORDER.map(tab => { 
                let isEnabled = false;
                if (tab === 'midterm') {
                    isEnabled = state.files.midterm;
                } else if (tab === 'final') {
                    isEnabled = state.files.final;
                } else if (tab === 'total') {
                    const wts = state.analysisSettings.weights;
                    const totWt = (wts.midterm || 0) + (wts.final || 0) + (wts.performance || 0);
                    isEnabled = totWt === 100 && allStudents.some(s => s.scores.total !== null);
                } 
                return `<button onclick="window.handleTabChange('${tab}')" 
                                class="whitespace-nowrap pb-3 px-1 border-b-2 font-semibold text-base transition-colors 
                                ${activeStatTab===tab && isEnabled ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-800'} 
                                ${!isEnabled ? 'cursor-not-allowed text-slate-300' : ''}" 
                                ${!isEnabled ? 'disabled' : ''}>
                            ${CONSTANTS.TABS[tab]}
                        </button>`; 
            }).join('');

            const studentsForTable = getFilteredStudents().filter(student => student.scores[activeStatTab] !== null);
            const tableHTML = renderStudentDataTable(getSortedStudents(studentsForTable), allStudents.length);
            
            // [MODIFIED] 로고 업로더 HTML (크기 h-11로 수정, 약 10% 감소)
            const logoUploaderHTML = `
                <label for="logo-upload" class="cursor-pointer group flex items-center justify-center w-full h-11"> 
                    <img id="logo-preview" src="${logoSrc || ''}" alt="School Logo" class="${logoSrc ? '' : 'hidden'} h-11 w-auto object-contain" /> 
                    <div id="logo-placeholder" class="${logoSrc ? 'hidden' : ''} flex flex-col items-center justify-center text-center h-11">
                        <svg class="w-6 h-6 text-slate-400 group-hover:text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                        <span class="text-xs font-semibold text-slate-500 mt-1">로고</span>
                    </div>
                    <input id="logo-upload" type="file" accept="image/*" class="hidden" />
                </label>`;

            dashboardContainer.innerHTML = `<div class="space-y-6">
                <div class="flex justify-between items-center border-b border-slate-200">
                    <nav class="flex space-x-8">${tabsHTML}</nav>
                    <div class="flex-shrink-0">
                         ${logoUploaderHTML}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-400 p-6 rounded-xl shadow-lg text-white">
                        <h3 class="font-medium text-blue-100">평균</h3>
                        <p class="text-4xl font-bold mt-1">${stats.mean.toFixed(2)}</p>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-6 rounded-xl shadow-lg text-white">
                        <h3 class="font-medium text-purple-100">표준편차</h3>
                        <p class="text-4xl font-bold mt-1">${stats.stdDev.toFixed(2)}</p>
                    </div>
                     <div class="bg-gradient-to-r from-green-500 to-emerald-400 p-6 rounded-xl shadow-lg text-white">
                        <h3 class="font-medium text-green-100">응시 인원</h3>
                        <p class="text-4xl font-bold mt-1">${stats.count}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 xl:grid-cols-5 gap-6">
                    <div id="pie-chart-wrapper" class="xl:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h3 class="text-lg font-semibold mb-4 text-slate-700">등급/성취도 분포</h3>
                        <div class="chart-container"><canvas id="pieChart"></canvas></div>
                    </div>
                    <div id="bar-chart-wrapper" class="xl:col-span-3 bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h3 class="text-lg font-semibold mb-4 text-slate-700">점수 분포 히스토그램</h3>
                        <div class="chart-container"><canvas id="barChart"></canvas></div>
                    </div>
                </div>
                ${tableHTML}
            </div>`;
            
            document.getElementById('logo-upload')?.addEventListener('change', window.handleLogoChange);

            setTimeout(() => { try { renderCharts(); } catch (chartError) {
                console.error("차트 렌더링 실패:", chartError);
                document.getElementById('pie-chart-wrapper').innerHTML = '<div class="flex items-center justify-center h-full text-red-500 p-4">파이 차트를 불러오지 못했습니다.</div>';
                document.getElementById('bar-chart-wrapper').innerHTML = '<div class="flex items-center justify-center h-full text-red-500 p-4">막대 차트를 불러오지 못했습니다.</div>';
            }}, 0);
        } else {
            dashboardContainer.innerHTML = `<div class="flex flex-col justify-center items-center h-full text-center p-8">
                <div class="mb-4">
                    <svg class="h-20 w-20 text-indigo-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-slate-700 mb-2">데이터를 업로드하여 분석을 시작하세요</h2>
                <p class="text-slate-500 max-w-sm">좌측에서 명렬표(CSV)와 성적(Excel) 파일을 업로드하면,<br>AI가 성적을 분석하여 상세한 대시보드를 제공합니다.</p>
            </div>`;
        }
    }
    
    function renderCharts() {
        if(pieChartInstance) pieChartInstance.destroy(); if(barChartInstance) barChartInstance.destroy();
        const { allStudents, analysisSettings, activeStatTab } = state;
        const pieCanvas = document.getElementById('pieChart'), barCanvas = document.getElementById('barChart');
        if(!pieCanvas || !barCanvas) { console.error("Chart canvas not found"); return; }
        
        const gridColor = '#e2e8f0'; 
        const textColor = '#334155';
        Chart.defaults.color = textColor;
        Chart.defaults.font.family = "'Inter', 'Pretendard', sans-serif"; 

        const distCounts = {}; allStudents.forEach(s => { let k = analysisSettings.gradingSystem === 'relative' ? String(s.grades[activeStatTab]) : s.achievements[activeStatTab]; if (k && k !== 'null' && k !== "0" && k !== "F") { distCounts[k] = (distCounts[k] || 0) + 1; } });
        const distData = Object.entries(distCounts).map(([name, value]) => ({ name, value })).sort((a, b) => a.name === '기타' ? 1 : b.name === '기타' ? -1 : String(a.name).localeCompare(String(b.name), undefined, { numeric: true }));
        if (distData.length > 0) { 
            const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#14b8a6', '#64748b', '#ef4444', '#a855f7']; 
            pieChartInstance = new Chart(pieCanvas.getContext('2d'), { 
                type: 'doughnut', 
                data: { 
                    labels: distData.map(d => d.name), 
                    datasets: [{ 
                        data: distData.map(d => d.value), 
                        backgroundColor: distData.map((d, i) => d.name === 'I' ? '#ef4444' : colors[i % colors.length]), 
                        borderColor: '#ffffff', 
                        borderWidth: 4 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            position: 'right', 
                            labels: { color: textColor, boxWidth: 12, padding: 15 } 
                        } 
                    }, 
                    // [MODIFIED] 파이 차트 두께 조절 (cutout: '50%')
                    cutout: '50%' 
                } 
            }); 
        } 
        
        const binLabels = ['0-9', '10-19', '20-29', '30-39', '40-49', '50-59', '60-69', '70-79', '80-89', '90-99', '100'];
        const bins = {};
        binLabels.forEach(label => bins[label] = 0);
        
        let scoreCount = 0;
        allStudents.forEach(s => {
            const score = s.scores[activeStatTab];
            if (score != null) {
                scoreCount++;
                if (score >= 100) {
                    bins['100']++;
                } else if (score >= 0) {
                    const bin = Math.floor(score / 10) * 10;
                    bins[`${bin}-${bin+9}`]++;
                }
            }
        });
        
        if (scoreCount > 0) {
            barChartInstance = new Chart(barCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: binLabels,
                    datasets: [{
                        label: '학생 수',
                        data: binLabels.map(label => bins[label]),
                        backgroundColor: '#60a5fa', 
                        borderRadius: 4,
                        barPercentage: 0.7, 
                        categoryPercentage: 0.8 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#334155', 
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            padding: 10,
                            cornerRadius: 4,
                        }
                    }
                }
            });
        }
    }

    function renderStudentDataTable(students, totalCount) {
        const { activeStatTab, sortConfig } = state;
        const cols = {
            total: [{k:'studentId',l:'학번'},{k:'name',l:'이름'},{k:'scores.midterm',l:'중간'},{k:'scores.final',l:'기말'},{k:'scores.performance',l:'수행'},{k:'scores.total',l:'합계'},{k:'ranks.total',l:'석차'},{k:'grades.total',l:'등급'},{k:'achievements.total',l:'성취도'}],
            midterm: [{k:'studentId',l:'학번'},{k:'name',l:'이름'},{k:'scores.midterm',l:'점수'},{k:'ranks.midterm',l:'석차'},{k:'grades.midterm',l:'등급'},{k:'achievements.midterm',l:'성취도'}],
            final: [{k:'studentId',l:'학번'},{k:'name',l:'이름'},{k:'scores.final',l:'점수'},{k:'ranks.final',l:'석차'},{k:'grades.final',l:'등급'},{k:'achievements.final',l:'성취도'}]
        }[activeStatTab];
        if (!cols) return '<div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200 text-red-500 text-center">데이터 테이블을 표시할 수 없습니다.</div>';
        
        const sortIcon = (key) => sortConfig?.key === key ? (sortConfig.direction === 'asc' ? `<svg class="w-3 h-3 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 15l7-7 7 7"/></svg>` : `<svg class="w-3 h-3 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"/></svg>`) : `<svg class="w-3 h-3 ml-1 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"/></svg>`;
        const headers = cols.map(c => `<th class="px-4 py-3 text-left text-sm font-semibold text-slate-500 uppercase tracking-wider cursor-pointer" onclick="window.handleSort('${c.k}')"><div class="flex items-center">${c.l}${sortIcon(c.k)}</div></th>`).join('');
        const getVal = (o, p) => p.split('.').reduce((a, c) => (a||{})[c], o);
        const rows = students.map(s => `<tr class="hover:bg-slate-50">${cols.map(c => { const v=getVal(s, c.k); const d=typeof v==='number'&&!Number.isInteger(v)?v.toFixed(2):(v??'—'); return `<td class="px-4 py-3 whitespace-nowrap text-sm ${(c.k.includes('achievements')&&v==='I')?'text-red-500 font-semibold':''} ${(c.k==='name'||c.k==='studentId')?'font-medium text-slate-900':''}">${d}</td>`; }).join('')}</tr>`).join('');
        
        return `<div class="bg-white rounded-xl shadow-lg border border-slate-200"><div class="flex justify-between items-center p-4 border-b border-slate-200"><h3 class="text-lg font-semibold text-slate-700">학생 데이터 (${students.length}/${totalCount})</h3><button onclick="window.exportToCSV()" class="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white text-sm font-semibold rounded-md hover:bg-indigo-700 transition-colors"><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>CSV 내보내기</button></div><div class="overflow-x-auto"><table class="w-full"><thead class="bg-slate-50"><tr>${headers}</tr></thead><tbody class="divide-y divide-slate-200">${students.length>0?rows:`<tr><td colspan="${cols.length}" class="text-center py-16 text-slate-500">필터와 일치하는 학생이 없습니다.</td></tr>`}</tbody></table></div></div>`;
    }

    // --- EVENT HANDLERS & CORE LOGIC ---
    function setupEventListeners() {
    }
    
    function setupDropzoneEventListeners() {
        const dropzone = document.querySelector('label[for="file-upload"]');
        if (!dropzone) return;
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.add('bg-indigo-50'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.remove('bg-indigo-50'), false);
        });
        dropzone.addEventListener('drop', handleDrop, false);
    }
    
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    function handleDrop(e) { window.handleFileChange({ target: e.dataTransfer }); }
    
    window.handleFileChange = (event) => {
        const files = event.target.files || event.dataTransfer.files;
        Array.from(files).forEach(f => {
            if (f.name.includes('명렬표')) {
                state.files.roster = f;
            }
        });
        processFilesWithDebounce();
    };
    
    window.handleLogoChange = (event) => { 
        if (event.target.files && event.target.files[0]) { 
            const r = new FileReader(); 
            r.onload = (e) => { 
                state.logoSrc = e.target.result; 
                render(); 
            }; 
            r.readAsDataURL(event.target.files[0]); 
        }
    };
    
    window.handleWeightChange = (exam, value) => { state.analysisSettings.weights[exam] = Math.max(0, Math.min(100, parseInt(value, 10) || 0)); reAnalyzeData(); };
    window.handleSettingsChange = (key, value) => { state.analysisSettings[key] = value; if (key === 'gradingSystem' || key === 'gradeTiers') { state.filters.grades = []; } reAnalyzeData(); };
    window.handleCutoffChange = (level, score) => { const { gradeTiers } = state.analysisSettings; if ((gradeTiers === 9 && level === 'E') || (gradeTiers === 5 && level === 'I')) return; const key = gradeTiers === 9 ? 'achievementCutoffs9Tier' : 'achievementCutoffs5Tier'; state.analysisSettings[key][state.activeStatTab][level] = parseFloat(score) || 0; reAnalyzeData(); };
    window.handleFilterChange = (type, value) => { const set = new Set(state.filters[type]); if (set.has(value)) { set.delete(value); } else { set.add(value); } state.filters[type] = Array.from(set); render(); };
    window.handleSelectAll = (type) => { const { gradeTiers, gradingSystem, achievementCutoffs9Tier, achievementCutoffs5Tier } = state.analysisSettings; const currentCutoffs = gradeTiers === 9 ? achievementCutoffs9Tier[state.activeStatTab] : achievementCutoffs5Tier[state.activeStatTab]; const allVals = type==='classes'?state.classList:gradingSystem==='relative'?(gradeTiers===9?CONSTANTS.GRADES_9_TIER:CONSTANTS.GRADES_5_TIER).map(String):Object.keys(currentCutoffs); state.filters[type] = state.filters[type].length === allVals.length ? [] : allVals; render(); };
    window.handleTabChange = (tab) => { state.activeStatTab = tab; state.sortConfig = { key: `ranks.${tab}`, direction: 'asc' }; render(); };
    window.handleSort = (key) => { let dir = 'asc'; if (state.sortConfig?.key === key && state.sortConfig.direction === 'asc') { dir = 'desc'; } state.sortConfig = { key, direction: dir }; render(); };
    window.exportToCSV = () => { const{academicInfo,activeStatTab}=state;const studentsToExport=getSortedStudents(getFilteredStudents().filter(student=>student.scores[activeStatTab]!==null));const cols={total:[{k:'studentId',l:'학번'},{k:'name',l:'이름'},{k:'scores.midterm',l:'중간'},{k:'scores.final',l:'기말'},{k:'scores.performance',l:'수행'},{k:'scores.total',l:'합계'},{k:'ranks.total',l:'석차'},{k:'grades.total',l:'등급'},{k:'achievements.total',l:'성취도'}],midterm:[{k:'studentId',l:'학번'},{k:'name',l:'이름'},{k:'scores.midterm',l:'점수'},{k:'ranks.midterm',l:'석차'},{k:'grades.midterm',l:'등급'},{k:'achievements.midterm',l:'성취도'}],final:[{k:'studentId',l:'학번'},{k:'name',l:'이름'},{k:'scores.final',l:'점수'},{k:'ranks.final',l:'석차'},{k:'grades.final',l:'등급'},{k:'achievements.final',l:'성취도'}]}[activeStatTab];const info=[`학년도,${academicInfo.year}`,`학기,${academicInfo.semester}`,`학년,${academicInfo.grade}`,`과목,"${academicInfo.subject||''}"`].join('\n');const headers=cols.map(c=>`"${c.l}"`).join(',');const getVal=(o,p)=>p.split('.').reduce((a,c)=>(a||{})[c],o);const rows=studentsToExport.map(s=>cols.map(c=>{const v=getVal(s,c.k);const f=typeof v==='number'&&!Number.isInteger(v)?v.toFixed(2):(v??'');return `"${String(f).replace(/"/g,'""')}"`;}).join(','));const link=document.createElement("a");link.href=encodeURI("data:text/csv;charset=utf-8,"+'\uFEFF'+info+'\n\n'+headers+'\n'+rows.join('\n'));link.download=`성적분석_${academicInfo.year}_${academicInfo.semester}학기_${academicInfo.subject||'과목'}_${activeStatTab}.csv`;link.click();};

    // --- Data Processing (largely unchanged logic) ---
    let debounceTimer;
    function processFilesWithDebounce() { clearTimeout(debounceTimer); debounceTimer = setTimeout(processFiles, 500); }
    async function processFiles() {
        if (!state.files.roster) { return; }
        Object.assign(state, { isProcessing: true, analysisError: null, isReady: false }); render();
        try {
            const fileTexts={};for(const k in state.files){fileTexts[k]=await state.files[k].text();}
            const rosterCSV = parseCSV(fileTexts.roster); if (rosterCSV.length < 2) throw new Error("명렬표 파일에 헤더와 학생 데이터가 필요합니다.");
            const midtermData=fileTexts.midterm?parseCSV(fileTexts.midterm):[],finalData=fileTexts.final?parseCSV(fileTexts.final):[],performanceData=fileTexts.performance?parseCSV(fileTexts.performance):[];
            const classHeaders=rosterCSV[0],rosterBody=rosterCSV.slice(1);
            const scoreHeaders={midterm:midtermData[0]||null,final:finalData[0]||null,performance:performanceData[0]||null};
            const scoreBodies={midterm:midtermData.slice(1),final:finalData.slice(1),performance:performanceData.slice(1)};
            const classColMap=new Map(); classHeaders.forEach((h,i)=>{if(i>0&&h.trim()&&!isNaN(parseInt(h.trim()))){classColMap.set(h.trim(),i);}});
            if(classColMap.size===0)throw new Error("명렬표 CSV 헤더에서 숫자 형식의 반 정보를 찾을 수 없습니다.");
            const {grade}=state.academicInfo; const rawStudentData=[],classes=new Set();
            rosterBody.forEach((row,rowIndex)=>{ const studentNum=row[0];if(!studentNum||!studentNum.trim())return; for(const [classNumStr,colIndex] of classColMap.entries()){ const studentName=row[colIndex]; if(studentName&&studentName.trim()){ const className=`${grade}${String(classNumStr).padStart(2,'0')}`; classes.add(className); const findScore=(k)=>{const h=scoreHeaders[k],b=scoreBodies[k];if(!h||!b[rowIndex])return;const i=h.findIndex(x=>x.trim()===classNumStr);return i!==-1?b[rowIndex][i]:undefined;}; rawStudentData.push({studentId:`${className}${String(studentNum).padStart(2,'0')}`,name:studentName.trim(),class:className,number:studentNum.trim(),midtermScore:cleanScore(findScore('midterm')),finalScore:cleanScore(findScore('final')),performanceScore:cleanScore(findScore('performance'))});}}});
            if(rawStudentData.length===0)throw new Error("CSV에서 학생 데이터를 추출하지 못했습니다. 파일 형식을 확인하세요.");
            const analyzedStudents = analyzeData(rawStudentData, state.analysisSettings);
            const enabledTabs=[];
            const weights = state.analysisSettings.weights;
            const totalWeight = (weights.midterm || 0) + (weights.final || 0) + (weights.performance || 0);
            const hasTotalScores = totalWeight === 100 && analyzedStudents.some(s => s.scores.total !== null);
            
            if(hasTotalScores) enabledTabs.push('total');
            if(state.files.midterm) enabledTabs.push('midterm');
            if(state.files.final) enabledTabs.push('final');
            if (enabledTabs.length > 0 && !enabledTabs.includes(state.activeStatTab)) { state.activeStatTab = enabledTabs[0]; state.sortConfig = { key: `ranks.${enabledTabs[0]}`, direction: 'asc' }; }
            Object.assign(state,{allStudents:analyzedStudents,classList:Array.from(classes).sort(),isReady:true});
        } catch(error){console.error("CRITICAL ERROR:",error);Object.assign(state,{analysisError:error.message,allStudents:[],classList:[],isReady:false});}
        finally {state.isProcessing = false; render();}
    }
    function reAnalyzeData() { if (state.allStudents.length > 0) { const rawData = state.allStudents.map(s => ({ studentId:s.studentId, name:s.name, class:s.class, number:s.number, midtermScore:s.scores.midterm, finalScore:s.scores.final, performanceScore:s.scores.performance })); state.allStudents = analyzeData(rawData, state.analysisSettings); } render(); }
    function analyzeData(rawData, settings) {
        const studentsWithScores = rawData.map(s => {
            const { midtermScore, finalScore, performanceScore } = s;
            const { weights } = settings;
            let total = null;
            const midTermWeight = weights.midterm || 0;
            const finalWeight = weights.final || 0;
            const perfWeight = weights.performance || 0;
            
            if (midtermScore !== null && finalScore !== null && performanceScore !== null) { 
                total = (midtermScore * midTermWeight / 100) + (finalScore * finalWeight / 100) + (performanceScore * perfWeight / 100); 
            }
            else if (midtermScore !== null && performanceScore !== null && midTermWeight + perfWeight === 100) { 
                total = (midtermScore * midTermWeight / 100) + (performanceScore * perfWeight / 100); 
            }
            else if (finalScore !== null && performanceScore !== null && finalWeight + perfWeight === 100) { 
                total = (finalScore * finalWeight / 100) + (performanceScore * perfWeight / 100); 
            }
            else if (midtermScore !== null && finalScore !== null && midTermWeight + finalWeight === 100) { 
                total = (midtermScore * midTermWeight / 100) + (finalScore * finalWeight / 100); 
            }
            return { ...s, scores: { midterm:midtermScore, final:finalScore, performance:performanceScore, total }};
        });
        const calculateMetrics = (scoreKey) => {
            const valid = studentsWithScores.filter(s=>s.scores[scoreKey] !== null).map(s=>({id:s.studentId, score:s.scores[scoreKey]})); if(!valid.length) return {};
            const sorted = [...valid].sort((a,b)=>b.score-a.score);
            let rank = 1;
            for(let i=0; i < sorted.length; i++){ if(i > 0 && sorted[i].score < sorted[i-1].score){ rank = i + 1; } sorted[i].rank = rank; }
            const total = valid.length, tiers=settings.gradeTiers===9?CONSTANTS.GRADE_TIERS_9:CONSTANTS.GRADE_TIERS_5;
            const cutoffs = settings.gradeTiers === 9 ? settings.achievementCutoffs9Tier[scoreKey] : settings.achievementCutoffs5Tier[scoreKey];
            const sortedCutoffs=Object.entries(cutoffs).sort(([,a],[,b])=>b-a), sortedTiers=Object.entries(tiers).sort(([,a],[,b])=>a-b);
            const metrics={};
            for(const s of sorted){ const p=(s.rank/total)*100; let g=null,a='F'; for(const [t,m] of sortedTiers){if(p<=m){g=Number(t);break;}} for(const [l,c] of sortedCutoffs){if(s.score>=c){a=l;break;}} metrics[s.id]={rank:s.rank,grade:g,achievement:a}; }
            return metrics;
        };
        const metrics={midterm:calculateMetrics('midterm'),final:calculateMetrics('final'),total:calculateMetrics('total')};
        return studentsWithScores.map(s=>({...s, ranks:{midterm:metrics.midterm[s.studentId]?.rank??null,final:metrics.final[s.studentId]?.rank??null,total:metrics.total[s.studentId]?.rank??null}, grades:{midterm:metrics.midterm[s.studentId]?.grade??null,final:metrics.final[s.studentId]?.grade??null,total:metrics.total[s.studentId]?.grade??null}, achievements:{midterm:metrics.midterm[s.studentId]?.achievement??null,final:metrics.final[s.studentId]?.achievement??null,total:metrics.total[s.studentId]?.achievement??null}}));
    }
    function getFilteredStudents() { const {allStudents,filters,analysisSettings,activeStatTab}=state; if(!filters.classes.length&&!filters.grades.length)return allStudents; return allStudents.filter(s=>{const c=!filters.classes.length||filters.classes.includes(s.class);if(!c||!filters.grades.length)return c;const g=analysisSettings.gradingSystem==='relative'?String(s.grades[activeStatTab]):s.achievements[activeStatTab];return filters.grades.includes(g);});}
    function getSortedStudents(students) { const {sortConfig}=state; if (!sortConfig || !students.length) return students; const getVal=(o,p)=>p.split('.').reduce((a,c)=>(a||{})[c],o); return [...students].sort((a,b)=>{const aVal=getVal(a,sortConfig.key),bVal=getVal(b,sortConfig.key),aNull=aVal==null,bNull=bVal==null;if(aNull||bNull)return aNull&&bNull?0:aNull?1:-1;const comp=typeof aVal==='string'?aVal.localeCompare(bVal):aVal<bVal?-1:aVal>bVal?1:0;return sortConfig.direction==='asc'?comp:-comp;});}
    function parseCSV(text){if(text.charCodeAt(0)===0xFEFF)text=text.slice(1);const rows=[];let f='',q=!1,r=[];for(let i=0;i<text.length;i++){const c=text[i];if(q){if(c==='"'){if(i+1<text.length&&text[i+1]==='"'){f+='"';i++;}else{q=!1;}}else{f+=c;}}else{if(c==='"'){q=!0;}else if(c===','){r.push(f.trim());f='';}else if(c==='\n'||c==='\r'){if(f||r.length>0){r.push(f.trim());rows.push(r);}r=[];f='';if(c==='\r'&&text[i+1]==='\n'){i++;}}else{f+=c;}}}if(f||r.length>0){r.push(f.trim());rows.push(r);}return rows.filter(r=>r.length>1||(r.length===1&&r[0]));}
    function cleanScore(s){const n=parseFloat(s);return (s==null||String(s).trim()===''||isNaN(n))?null:n;}
    function calculateStats(students, key){if(!students.length)return{mean:0,stdDev:0,count:0};const scores=students.map(s=>s.scores[key]).filter(s=>s!=null&&!isNaN(s));if(!scores.length)return{mean:0,stdDev:0,count:0};const count=scores.length,mean=scores.reduce((a,b)=>a+b,0)/count,stdDev=Math.sqrt(scores.map(x=>Math.pow(x-mean,2)).reduce((a,b)=>a+b,0)/count);return{mean,stdDev,count};}
    
    let performanceFileCounter = 1;
    
    function getNextPerformanceNumber() {
        const existingNumbers = Object.keys(state.excelFiles)
            .filter(key => key.startsWith('performance'))
            .map(key => {
                const num = parseInt(key.replace('performance', ''));
                return isNaN(num) ? 1 : num;
            });
        
        if (existingNumbers.length === 0) {
            return 1;
        }
        
        return Math.max(...existingNumbers) + 1;
    }
    
    window.handleMultiplePerformanceFiles = async function(e) {
        const files = e.target.files;
        if (!files || files.length === 0) return;
        
        try {
            state.isProcessing = true;
            render();
            
            let startNumber = getNextPerformanceNumber();
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                try {
                    const result = await parseExcelFile(file);
                    const { metadata, csvData } = result;
                    
                    if (i === 0) {
                        if (metadata.year) state.academicInfo.year = metadata.year;
                        if (metadata.semester) state.academicInfo.semester = metadata.semester;
                        if (metadata.grade) state.academicInfo.grade = metadata.grade;
                        if (metadata.subject) state.academicInfo.subject = metadata.subject;
                    }
                    
                    const fileType = (i === 0 && startNumber === 1) ? 'performance' : `performance${startNumber + i}`;
                    
                    state.excelFiles[fileType] = file;
                    
                    const csvBlob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                    const csvFile = new File([csvBlob], `${fileType}_parsed.csv`, { type: 'text/csv' });
                    state.files[fileType] = csvFile;
                    
                    console.log(`✓ 파일 업로드 완료: ${fileType} (${file.name})`);
                } catch (fileError) {
                    console.error(`파일 처리 오류: ${file.name}`, fileError);
                    alert(`파일 처리 중 오류: ${file.name}\n${fileError.message}`);
                }
            }
            
            await mergeAndStorePerformanceFiles();
            
            e.target.value = '';
            
            processFilesWithDebounce();
        } catch (error) {
            console.error('Multiple file upload error:', error);
            alert('여러 파일 업로드 중 오류가 발생했습니다: ' + error.message);
            state.isProcessing = false;
            render();
        }
    };
    
    // --- Initializer ---
    setupEventListeners();
    
    // --- Excel File Handling ---
    window.handleExcelFileSelect = async function(e, type) {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            state.isProcessing = true;
            render();
            
            const result = await parseExcelFile(file);
            const { metadata, csvData } = result;
            
            if (metadata.year) state.academicInfo.year = metadata.year;
            if (metadata.semester) state.academicInfo.semester = metadata.semester;
            if (metadata.grade) state.academicInfo.grade = metadata.grade;
            if (metadata.subject) state.academicInfo.subject = metadata.subject;
            
            state.excelFiles[type] = file;
            
            const csvBlob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const csvFile = new File([csvBlob], `${type}_parsed.csv`, { type: 'text/csv' });
            state.files[type] = csvFile;
            
            if (type.startsWith('performance')) {
                await mergeAndStorePerformanceFiles();
            }
            
            processFilesWithDebounce();
        } catch (error) {
            console.error('Excel parsing error:', error);
            alert('엑셀 파일 파싱 중 오류가 발생했습니다: ' + error.message);
            state.isProcessing = false;
            render();
        }
    };
    
    async function mergeAndStorePerformanceFiles() {
        const performanceKeys = Object.keys(state.files)
            .filter(key => key.startsWith('performance'))
            .sort((a, b) => {
                const numA = parseInt(a.replace('performance', '')) || 0;
                const numB = parseInt(b.replace('performance', '')) || 0;
                return numA - numB;
            });
        
        if (performanceKeys.length === 0) return;
        
        if (performanceKeys.length === 1) {
            state.files.performance = state.files[performanceKeys[0]];
            return;
        }
        
        try {
            const mergedCsv = await mergePerformanceFiles(performanceKeys);
            const csvBlob = new Blob([mergedCsv], { type: 'text/csv;charset=utf-8;' });
            const csvFile = new File([csvBlob], 'performance_merged.csv', { type: 'text/csv' });
            state.files.performance = csvFile;
        } catch (error) {
            console.error('수행평가 합산 오류:', error);
            state.files.performance = state.files[performanceKeys[0]];
        }
    }
    
    async function mergePerformanceFiles(performanceKeys) {
        const parsedFiles = [];
        
        for (const key of performanceKeys) {
            const csvFile = state.files[key];
            if (!csvFile) continue;
            
            const csvData = await csvFile.text();
            
            const lines = csvData.trim().split('\n');
            if (lines.length < 2) continue;
            
            const header = lines[0]
                .split(',')
                .map(h => h.replace(/"/g, '').trim());
            
            const data = {};
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const cells = [];
                let cell = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        cells.push(cell.replace(/"/g, '').trim());
                        cell = '';
                    } else {
                        cell += char;
                    }
                }
                cells.push(cell.replace(/"/g, '').trim());
                
                const studentNum = parseInt(cells[0]);
                if (isNaN(studentNum)) continue;
                
                if (!data[studentNum]) {
                    data[studentNum] = {};
                }
                
                for (let j = 1; j < header.length; j++) {
                    const classNum = parseInt(header[j]);
                    const scoreStr = cells[j];
                    
                    if (!isNaN(classNum) && scoreStr !== '') {
                        const score = parseFloat(scoreStr) || 0;
                        if (score > 0) {
                            if (!data[studentNum][classNum]) {
                                data[studentNum][classNum] = 0;
                            }
                            data[studentNum][classNum] += score;
                        }
                    }
                }
            }
            
            parsedFiles.push(data);
        }
        
        if (parsedFiles.length === 0) {
            throw new Error('파싱할 수행평가 파일이 없습니다.');
        }
        
        const mergedData = {};
        for (const fileData of parsedFiles) {
            for (const [studentNum, scores] of Object.entries(fileData)) {
                const num = parseInt(studentNum);
                if (!mergedData[num]) {
                    mergedData[num] = {};
                }
                
                for (const [classNum, score] of Object.entries(scores)) {
                    const cn = parseInt(classNum);
                    if (!mergedData[num][cn]) {
                        mergedData[num][cn] = 0;
                    }
                    mergedData[num][cn] += score;
                }
            }
        }
        
        const allClasses = new Set();
        for (const scores of Object.values(mergedData)) {
            for (const classNum of Object.keys(scores)) {
                allClasses.add(parseInt(classNum));
            }
        }
        const sortedClasses = Array.from(allClasses).sort((a, b) => a - b);
        
        const csvHeader = ['번호 / 반', ...sortedClasses.map(String)];
        const csvLines = [csvHeader.map(h => `"${h}"`).join(',')];
        
        const sortedStudents = Object.keys(mergedData)
            .map(Number)
            .sort((a, b) => a - b);
        
        for (const studentNum of sortedStudents) {
            const rowData = [studentNum];
            for (const classNum of sortedClasses) {
                const score = mergedData[studentNum][classNum] || '';
                rowData.push(score);
            }
            csvLines.push(rowData.map(cell => `"${cell}"`).join(','));
        }
        
        return csvLines.join('\n');
    }
    
    window.removeExcelFile = function(type) {
        delete state.excelFiles[type];
        delete state.files[type];
        
        if (type.startsWith('performance')) {
            const remainingPerformanceKeys = Object.keys(state.files)
                .filter(key => key.startsWith('performance'));
            
            if (remainingPerformanceKeys.length > 0) {
                mergeAndStorePerformanceFiles();
            } else {
                delete state.files.performance;
            }
        }
        
        processFilesWithDebounce();
    };
    
    async function parseExcelFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    const range = XLSX.utils.decode_range(firstSheet['!ref']);
                    
                    const metadata = { year: null, semester: null, grade: null, subject: null };
                    for (let row = 1; row <= 6; row++) {
                        for (let col = 0; col <= range.e.c; col++) {
                            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                            const cell = firstSheet[cellRef];
                            if (!cell) continue;
                            
                            const cellValue = cell.v ? String(cell.v) : '';
                            if (!cellValue) continue;
                            
                            const yearMatch = cellValue.match(/(\d{4})학년도/);
                            const semesterMatch = cellValue.match(/(\d+)학기/);
                            const subjectMatch = cellValue.match(/교과목\s*:\s*(.+?)(?:\s+만점|\(|$)/);
                            
                            if (yearMatch) metadata.year = parseInt(yearMatch[1]);
                            if (semesterMatch) metadata.semester = parseInt(semesterMatch[1]);
                            if (subjectMatch) {
                                let subject = subjectMatch[1].trim();
                                if (subject.includes(':')) {
                                    const parts = subject.split(':');
                                    subject = parts[parts.length - 1].trim();
                                }
                                metadata.subject = subject;
                            }
                            
                            if (!metadata.grade) {
                                const gradeAfterWeekMatch = cellValue.match(/주간\s+(\d+)학년/);
                                if (gradeAfterWeekMatch) {
                                    metadata.grade = parseInt(gradeAfterWeekMatch[1]);
                                } else {
                                    const lastThreeChars = cellValue.slice(-3);
                                    const gradeMatch = lastThreeChars.match(/(\d+)학년/);
                                    if (gradeMatch) {
                                        metadata.grade = parseInt(gradeMatch[1]);
                                    }
                                }
                            }
                        }
                    }
                    
                    let headerRowIdx = -1;
                    for (let row = 0; row < Math.min(20, range.e.r + 1); row++) {
                        let hasHeaderKeyword = false;
                        for (let col = 0; col <= range.e.c; col++) {
                            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                            const cell = firstSheet[cellRef];
                            if (cell && String(cell.v || '').includes('번호')) {
                                hasHeaderKeyword = true;
                                break;
                            }
                        }
                        if (hasHeaderKeyword) {
                            headerRowIdx = row;
                            break;
                        }
                    }
                    
                    if (headerRowIdx === -1) throw new Error('헤더 행을 찾을 수 없습니다.');
                    
                    const classMap = new Map();
                    for (let col = 1; col <= range.e.c; col++) {
                        const cellRef = XLSX.utils.encode_cell({r: headerRowIdx, c: col});
                        const cell = firstSheet[cellRef];
                        const cellValue = cell && cell.v ? String(cell.v).trim() : '';
                        if (cellValue && !isNaN(parseInt(cellValue))) {
                            const classNum = parseInt(cellValue);
                            classMap.set(classNum, col);
                        }
                    }
                    
                    const students = [];
                    const dataStartRow = headerRowIdx + 1;
                    
                    let dataEndRow = Math.min(dataStartRow + 35, range.e.r);
                    let attendanceCount = null;
                    let summaryRowStart = null;
                    
                    for (let row = dataStartRow; row <= Math.min(dataStartRow + 40, range.e.r); row++) {
                        const cellRef = XLSX.utils.encode_cell({r: row, c: 1});
                        const cell = firstSheet[cellRef];
                        if (!cell) continue;
                        
                        const cellValue = String(cell.v || '').trim();
                        
                        if (cellValue.includes('응시생수') || 
                            cellValue.includes('응시') && !isNaN(parseInt(cellValue.charAt(0)))) {
                            dataEndRow = row - 1;
                            summaryRowStart = row;
                            
                            for (let col = 2; col <= Math.min(4, range.e.c); col++) {
                                const numCellRef = XLSX.utils.encode_cell({r: row, c: col});
                                const numCell = firstSheet[numCellRef];
                                if (numCell && typeof numCell.v === 'number') {
                                    attendanceCount = parseInt(numCell.v);
                                    console.log(`✓ 응시인원: ${attendanceCount}명 (${cellValue})`);
                                    break;
                                }
                            }
                            break;
                        }
                    }
                    
                    console.log(`✓ 파싱 범위: row ${dataStartRow}~${dataEndRow} (Excel: ${dataStartRow + 1}~${dataEndRow + 1}행)`);
                    
                    for (let row = dataStartRow; row <= dataEndRow; row++) {
                        const studentNumCell = firstSheet[XLSX.utils.encode_cell({r: row, c: 1})];
                        if (!studentNumCell || !studentNumCell.v) break;
                        
                        const studentNumStr = String(studentNumCell.v).trim();
                        
                        if (isNaN(parseInt(studentNumStr)) || 
                            studentNumStr.includes('응시') || 
                            studentNumStr.includes('총') || 
                            studentNumStr.includes('평균')) {
                            console.log(`⏹️ 파싱 종료: "${studentNumStr}" (요약 행 감지)`);
                            break;
                        }
                        
                        let studentNum;
                        try {
                            studentNum = parseInt(studentNumStr);
                            if (isNaN(studentNum)) break;
                        } catch {
                            break;
                        }
                        
                        const studentData = { number: studentNum, scores: {} };
                        
                        classMap.forEach((col, classNum) => {
                            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                            const scoreCell = firstSheet[cellRef];
                            if (scoreCell && scoreCell.v !== null && scoreCell.v !== undefined) {
                                const scoreVal = scoreCell.v;
                                if (typeof scoreVal === 'number') {
                                    studentData.scores[classNum] = scoreVal;
                                } else if (typeof scoreVal === 'string') {
                                    const scoreNum = parseFloat(scoreVal);
                                    if (!isNaN(scoreNum)) {
                                        studentData.scores[classNum] = scoreNum;
                                    }
                                }
                            }
                        });
                        
                        students.push(studentData);
                    }
                    
                    console.log(`📊 파싱된 학생 수: ${students.length}명`);
                    
                    if (attendanceCount && students.length !== attendanceCount) {
                        console.warn(`⚠️ 경고: 파싱된 학생(${students.length}) ≠ 응시인원(${attendanceCount})`);
                        console.warn(`   → 응시하지 않은 학생이 포함되었거나 데이터가 누락되었을 수 있습니다.`);
                    }
                    
                    let incompleteStudents = [];
                    students.forEach(s => {
                        const scoreCount = Object.values(s.scores).filter(
                            v => v !== null && v !== undefined && !isNaN(v)
                        ).length;
                        if (scoreCount === 0) {
                            incompleteStudents.push(s.number);
                        }
                    });
                    
                    if (incompleteStudents.length > 0) {
                        console.warn(`⚠️ 점수 없는 학생: ${incompleteStudents.join(', ')}번`);
                        console.warn(`   → 해당 학생들은 시험에 응시하지 않았거나 성적이 미입력되었습니다.`);
                    }
                    
                    const sortedClasses = Array.from(classMap.keys()).sort((a, b) => a - b);
                    const header = ['번호 / 반', ...sortedClasses.map(String)];
                    const csvRows = [header.map(h => `"${h}"`).join(',')];
                    
                    students.forEach(s => {
                        const rowData = [s.number];
                        sortedClasses.forEach(classNum => {
                            const score = s.scores[classNum] ?? '';
                            rowData.push(score);
                        });
                        csvRows.push(rowData.map(cell => `"${cell}"`).join(','));
                    });
                    const csvData = csvRows.join('\n');
                    
                    resolve({ metadata, csvData });
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }


    
    render();
});
</script>
</body>
</html>
