<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‚´ì‹  ì„±ì  ë¶„ì„ ëŒ€ì‹œë³´ë“œ (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', 'Pretendard', sans-serif; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        /* Sidebar Transition */
        #sidebar { transition: transform 0.3s ease-in-out; }
    
        .file-upload-area { border: 2px dashed #cbd5e1; transition: all 0.2s; }
        .file-upload-area:hover { border-color: #0ea5e9; background-color: #f0f9ff; }
        .file-upload-area.dragging { border-color: #0ea5e9; background-color: #e0f2fe; }
</style>
</head>
<body class="bg-white text-slate-800 antialiased">
    <div id="app" class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 bg-white w-96 h-screen shadow-xl z-20 transform -translate-x-full md:relative md:translate-x-0 flex flex-col">
            <header class="flex items-center justify-between p-4 bg-gradient-to-br from-cyan-600 to-indigo-600 text-white flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    </div>
                    <h1 class="text-xl font-bold">ì„±ì  ë¶„ì„ ì„¤ì •</h1>
                </div>
                <button id="close-sidebar-btn" class="md:hidden p-1 rounded-full text-white/80 hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </header>
            
            <div id="sidebar-content" class="flex-grow overflow-y-auto p-6 space-y-8 bg-sky-50"></div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between p-4 bg-sky-50 border-b border-slate-200 flex-shrink-0">
                <div class="flex items-center gap-4">
                     <button id="open-sidebar-btn" class="md:hidden p-1 rounded-full text-slate-500 hover:bg-slate-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                    <div id="academic-info-container" class="flex items-center flex-wrap gap-4"></div>
                </div>
                <div id="logo-container" class="flex-shrink-0"></div>
            </header>
            
            <main id="dashboard-container" class="flex-1 overflow-y-auto p-6 lg:p-8">
                <!-- Dashboard content will be rendered here -->
            </main>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONSTANTS AND STATE ---
    const CONSTANTS = { GRADE_TIERS_9: { 1: 4, 2: 11, 3: 23, 4: 40, 5: 60, 6: 77, 7: 89, 8: 96, 9: 100 }, GRADES_9_TIER: [1, 2, 3, 4, 5, 6, 7, 8, 9], GRADE_TIERS_5: { 1: 10, 2: 34, 3: 66, 4: 90, 5: 100 }, GRADES_5_TIER: [1, 2, 3, 4, 5], 
        DEFAULT_ACHIEVEMENT_CUTOFFS_9_TIER: { A: 85, B: 70, C: 55, D: 40, E: 0 },
        DEFAULT_ACHIEVEMENT_CUTOFFS_5_TIER: { A: 85, B: 70, C: 60, D: 45, E: 30, I: 0 }, 
        FILE_METADATA: { roster: { name: 'ëª…ë ¬í‘œ', label: 'ëª…ë ¬í‘œ' }, midterm: { name: 'ì¤‘ê°„', label: 'ì¤‘ê°„ê³ ì‚¬' }, final: { name: 'ê¸°ë§', label: 'ê¸°ë§ê³ ì‚¬' }, performance: { name: 'ìˆ˜í–‰', label: 'ìˆ˜í–‰í‰ê°€' } }, TABS: { midterm: 'ì¤‘ê°„ê³ ì‚¬', final: 'ê¸°ë§ê³ ì‚¬', total: 'í•©ì‚° ì ìˆ˜' }, TABS_ORDER: ['midterm', 'final', 'total'] };
    
    let state = { files: {}, excelFiles: {}, logoSrc: null, academicInfo: { year: new Date().getFullYear(), semester: 1, grade: 1, subject: '' }, analysisSettings: { weights: { midterm: 30, final: 30, performance: 40 }, gradingSystem: 'relative', gradeTiers: 9, 
        achievementCutoffs9Tier: { midterm: {...CONSTANTS.DEFAULT_ACHIEVEMENT_CUTOFFS_9_TIER}, final: {...CONSTANTS.DEFAULT_ACHIEVEMENT_CUTOFFS_9_TIER}, total: {...CONSTANTS.DEFAULT_ACHIEVEMENT_CUTOFFS_9_TIER} },
        achievementCutoffs5Tier: { midterm: {...CONSTANTS.DEFAULT_ACHIEVEMENT_CUTOFFS_5_TIER}, final: {...CONSTANTS.DEFAULT_ACHIEVEMENT_CUTOFFS_5_TIER}, total: {...CONSTANTS.DEFAULT_ACHIEVEMENT_CUTOFFS_5_TIER} }
    }, filters: { classes: [], grades: [] }, activeStatTab: 'midterm', allStudents: [], classList: [], analysisError: null, isProcessing: false, isReady: false, sortConfig: { key: 'ranks.midterm', direction: 'asc' }, isSidebarOpen: false };
    
    const DOMElements = { 
        sidebarContent: document.getElementById('sidebar-content'),
        academicInfoContainer: document.getElementById('academic-info-container'),
        logoContainer: document.getElementById('logo-container'),
        dashboardContainer: document.getElementById('dashboard-container'),
        sidebar: document.getElementById('sidebar'),
        openSidebarBtn: document.getElementById('open-sidebar-btn'),
        closeSidebarBtn: document.getElementById('close-sidebar-btn'),
    };
    let pieChartInstance = null, barChartInstance = null;

    // --- RENDER FUNCTIONS ---
    function render() {
        renderSidebar();
        renderHeader();
        renderDashboard(); 
    }
    
    function renderSidebar() {
        const { files, analysisSettings: s, filters, classList, isReady, activeStatTab } = state;
        const totalWeight = Object.values(s.weights).reduce((sum, v) => sum + v, 0);
        
        const is9Tier = s.gradeTiers === 9;
        const activeColor = is9Tier ? 'green' : 'indigo';
        const activeBgClass = `bg-${activeColor}-600`;
        const activeTextClass = `text-${activeColor}-600`;
        const focusRingClass = `peer-focus:ring-${activeColor}-300`;
        const lightBgClass = `bg-${activeColor}-50`;
        const lightBorderClass = `border-${activeColor}-200`;
        const lightTextClass = `text-${activeColor}-800`;

        const fileUploadHTML = `<div class="space-y-3">
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800 mb-3">
                <p class="font-semibold mb-1">ğŸ“‹ ëª…ë ¬í‘œ CSV ì—…ë¡œë“œ (í•„ìˆ˜)</p>
                <p class="text-xs">ëª…ë ¬í‘œëŠ” ë°˜ë“œì‹œ CSV íŒŒì¼ë¡œ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.</p>
            </div>
            <label for="file-upload" class="cursor-pointer group">
                <div class="flex flex-col items-center justify-center border-2 border-dashed border-slate-300 rounded-lg p-6 text-center bg-white group-hover:border-${activeColor}-500 transition-colors">
                    <svg class="w-10 h-10 text-slate-400 group-hover:text-${activeColor}-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                    <p class="mt-2 font-semibold">ëª…ë ¬í‘œ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸</p>
                    <p class="text-sm text-slate-500">.csv íŒŒì¼ë§Œ ê°€ëŠ¥</p>
                </div>
                <input id="file-upload" type="file" accept=".csv" class="hidden">
            </label>
            ${files.roster ? `
                <div class="flex items-center gap-2 p-3 rounded-md bg-green-100 text-green-700">
                    <svg viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                    <span class="font-medium">ëª…ë ¬í‘œ: ${files.roster.name}</span>
                </div>
            ` : `
                <div class="flex items-center gap-2 p-3 rounded-md bg-slate-100 text-slate-500">
                    <div class="w-5 h-5 border-2 border-slate-400 rounded-full"></div>
                    <span>ëª…ë ¬í‘œ (í•„ìˆ˜)</span>
                </div>
            `}
            <div class="text-xs text-slate-600 space-y-1 bg-slate-50 p-3 rounded-md border border-slate-200">
                <p class="font-semibold">CSV íŒŒì¼ í˜•ì‹:</p>
                <ol class="list-decimal list-inside space-y-1">
                    <li>íŒŒì¼ì€ <strong>CSV (UTF-8)</strong> í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
                    <li>íŒŒì¼ ì´ë¦„ì— <strong>'ëª…ë ¬í‘œ'</strong>ê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
                </ol>
            </div>
        </div>`;

        const excelUploadHTML = `<div class="space-y-3">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800">
                <p class="font-semibold mb-1">ğŸ’¡ ë‚˜ì´ìŠ¤ ì—‘ì…€ ì—…ë¡œë“œ ë°©ë²•</p>
                <ul class="text-xs space-y-1">
                    <li>â€¢ ë‚˜ì´ìŠ¤ì—ì„œ ë‹¤ìš´ë¡œë“œí•œ ì—‘ì…€ íŒŒì¼ì„ ê·¸ëŒ€ë¡œ ì—…ë¡œë“œ</li>
                    <li>â€¢ í•™ë…„ë„, í•™ê¸°, í•™ë…„, ê³¼ëª©ì´ <strong>ìë™ìœ¼ë¡œ ì¶”ì¶œ</strong>ë©ë‹ˆë‹¤</li>
                    <li>â€¢ ì¤‘ê°„ê³ ì‚¬, ê¸°ë§ê³ ì‚¬, ìˆ˜í–‰í‰ê°€ ê°ê° ì—…ë¡œë“œ</li>
                </ul>
            </div>
            ${['midterm', 'final'].map(type => {
                const hasFile = !!state.excelFiles[type];
                const fileName = hasFile ? state.excelFiles[type].name : '';
                const label = {midterm:'ì¤‘ê°„ê³ ì‚¬', final:'ê¸°ë§ê³ ì‚¬'}[type];
                return `<div class="file-upload-area rounded-lg p-4 cursor-pointer" onclick="document.getElementById('excel-${type}').click()">
                    <input id="excel-${type}" type="file" accept=".xlsx,.xls" class="hidden" onchange="handleExcelFileSelect(event, '${type}')">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                        <div class="flex-1">
                            ${hasFile ? `<p class="text-sm font-medium text-slate-800">${fileName}</p><p class="text-xs text-green-600">âœ“ ì—…ë¡œë“œ ì™„ë£Œ</p>` : `<p class="text-sm text-slate-600">${label} (.xlsx, .xls)</p><p class="text-xs text-slate-400">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</p>`}
                        </div>
                        ${hasFile ? `<button onclick="event.stopPropagation(); removeExcelFile('${type}')" class="text-red-500 hover:text-red-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>` : ''}
                    </div>
                </div>`;
            }).join('')}
            
            <!-- ìˆ˜í–‰í‰ê°€ íŒŒì¼ë“¤ -->
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-sm text-slate-800">ìˆ˜í–‰í‰ê°€ (ì—¬ëŸ¬ íŒŒì¼ ê°€ëŠ¥)</h3>
                    <button onclick="document.getElementById('excel-performance-files-multi').click()" class="text-xs bg-indigo-600 text-white px-2 py-1 rounded hover:bg-indigo-700">+ ì¶”ê°€</button>
                    <input id="excel-performance-files-multi" type="file" accept=".xlsx,.xls" multiple class="hidden" onchange="handleMultiplePerformanceFiles(event)">
                </div>
                <div id="performance-files-container" class="space-y-2">
                    ${Object.keys(state.excelFiles)
                        .filter(key => key.startsWith('performance'))
                        .sort((a, b) => {
                            const numA = parseInt(a.replace('performance', '')) || 1;
                            const numB = parseInt(b.replace('performance', '')) || 1;
                            return numA - numB;
                        })
                        .map(type => {
                            const hasFile = !!state.excelFiles[type];
                            const fileName = hasFile ? state.excelFiles[type].name : '';
                            const perfNum = type === 'performance' ? '1' : (type.replace('performance', '') || '1');
                            return `<div class="file-upload-area rounded-lg p-3 cursor-pointer">
                                <div class="flex items-center gap-3">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                                    <div class="flex-1">
                                        ${hasFile ? `<p class="text-xs font-medium text-slate-800">${perfNum}ì°¨: ${fileName}</p><p class="text-xs text-green-600">âœ“ ì—…ë¡œë“œ ì™„ë£Œ</p>` : `<p class="text-xs text-slate-600">ìˆ˜í–‰í‰ê°€ ${perfNum}ì°¨ (.xlsx, .xls)</p><p class="text-xs text-slate-400">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</p>`}
                                    </div>
                                    <button onclick="event.stopPropagation(); removeExcelFile('${type}')" class="text-red-500 hover:text-red-700"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                                </div>
                            </div>`;
                        }).join('')}
                </div>
            </div>
        </div>`;

        const weightsHTML = `<div class="space-y-4">${Object.keys(s.weights).map(k => `<div><div class="flex justify-between mb-1"><label class="font-medium text-sm">${{midterm:"ì¤‘ê°„ê³ ì‚¬",final:"ê¸°ë§ê³ ì‚¬",performance:"ìˆ˜í–‰í‰ê°€"}[k]}</label><div class="flex items-center"><input type="number" min="0" max="100" value="${s.weights[k]}" onchange="window.handleWeightChange('${k}',this.value)" class="w-16 p-1 bg-white border border-slate-300 rounded-md text-center text-sm"><span class="ml-2 font-semibold">%</span></div></div><input type="range" min="0" max="100" value="${s.weights[k]}" oninput="window.handleWeightChange('${k}',this.value)" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"></div>`).join('')}${totalWeight!==100?`<p class="text-xs text-center p-2 rounded-md ${totalWeight>100?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}">ì´í•©ì€ 100%ì—¬ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬: ${totalWeight}%)</p>`:''}</div>`;

        const gradeTierToggleHTML = `<div class="flex items-center justify-center gap-3">
            <span class="font-semibold text-sm ${is9Tier ? 'text-green-600' : 'text-slate-400'}">9 ë“±ê¸‰ì œ</span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" class="sr-only peer" onchange="window.handleSettingsChange('gradeTiers', this.checked ? 5 : 9)" ${s.gradeTiers === 5 ? 'checked' : ''}>
                <div class="w-11 h-6 ${is9Tier ? 'bg-green-600' : 'bg-indigo-600'} rounded-full peer peer-focus:ring-4 ${is9Tier ? 'peer-focus:ring-green-300' : 'peer-focus:ring-indigo-300'} after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full after:border-white"></div>
            </label>
            <span class="font-semibold text-sm ${!is9Tier ? 'text-indigo-600' : 'text-slate-400'}">5 ë“±ê¸‰ì œ</span>
        </div>`;
        
        const currentCutoffs = s.gradeTiers === 9 ? s.achievementCutoffs9Tier[activeStatTab] : s.achievementCutoffs5Tier[activeStatTab];
        const cutoffsHTML = Object.entries(currentCutoffs).sort(([a],[b]) => a.localeCompare(b)).map(([l, v]) => {
            const isLocked = (s.gradeTiers === 9 && l === 'E') || (s.gradeTiers === 5 && l === 'I');
            return `<div><label class="font-bold text-sm ${l==='I'?'text-red-500':'text-slate-500'}">${l}</label><input type="number" step="0.01" value="${isLocked?0:v}" onchange="window.handleCutoffChange('${l}', this.value)" class="w-full mt-1 p-1 bg-white border border-slate-300 rounded-md text-center text-sm ${isLocked?'cursor-not-allowed opacity-60':''}" ${isLocked?'disabled':''}></div>`;
        }).join('');

        const analysisSettingsHTML = `<div class="space-y-4">
            ${gradeTierToggleHTML}
            <div class="grid grid-cols-2 gap-2 text-sm">
                <button onclick="window.handleSettingsChange('gradingSystem','relative')" class="py-2 font-semibold rounded-md transition-colors ${s.gradingSystem==='relative'?`${activeBgClass} text-white`:'bg-white border hover:bg-slate-100'}">ìƒëŒ€í‰ê°€ (ë“±ê¸‰)</button>
                <button onclick="window.handleSettingsChange('gradingSystem','absolute')" class="py-2 font-semibold rounded-md transition-colors ${s.gradingSystem==='absolute'?`${activeBgClass} text-white`:'bg-white border hover:bg-slate-100'}">ì„±ì·¨ë„(ë¶„í• ì ìˆ˜)</button>
            </div>
            ${s.gradingSystem==='absolute'?`<div class="space-y-2 p-3 ${lightBgClass} ${lightBorderClass} rounded-lg pt-4"><p class="font-medium ${lightTextClass} text-center text-sm">ì„±ì·¨ë„ ë¶„í•  ì ìˆ˜ (${CONSTANTS.TABS[activeStatTab]})</p><div class="grid grid-cols-3 gap-2 mt-2">${cutoffsHTML}</div></div>`:''}
        </div>`;

        const gradeOpts = s.gradingSystem === 'relative' ? (s.gradeTiers === 9 ? CONSTANTS.GRADES_9_TIER.map(String) : CONSTANTS.GRADES_5_TIER.map(String)) : Object.keys(currentCutoffs);
        const classFilterHTML=classList.map(c=>`<button onclick="window.handleFilterChange('classes','${c}')" class="px-2 py-1 text-sm rounded-md transition-colors ${filters.classes.includes(c)?`${activeBgClass} text-white font-semibold`:'bg-white border hover:bg-slate-100'}">${c}</button>`).join('');
        const gradeFilterHTML=gradeOpts.map(g=>`<button onclick="window.handleFilterChange('grades','${g}')" class="px-2 py-1 text-sm rounded-md transition-colors ${filters.grades.includes(g)?`${activeBgClass} text-white font-semibold`:`bg-white border hover:bg-slate-100 ${g==='I'?'text-red-500 font-bold':''}`}">${g}</button>`).join('');
        const filtersHTML = isReady ? `<div class="space-y-4"><div class="space-y-2">
            <div class="flex justify-between items-center"><h3 class="font-semibold text-sm">í•™ê¸‰</h3><button onclick="window.handleSelectAll('classes')" class="text-xs ${activeTextClass} hover:underline">${filters.classes.length===classList.length?'ì „ì²´í•´ì œ':'ì „ì²´ì„ íƒ'}</button></div>
            <div class="grid grid-cols-4 gap-2">${classFilterHTML}</div></div><div class="space-y-2">
            <div class="flex justify-between items-center"><h3 class="font-semibold text-sm">${s.gradingSystem==='relative'?'ë“±ê¸‰':'ì„±ì·¨ë„'}</h3><button onclick="window.handleSelectAll('grades')" class="text-xs ${activeTextClass} hover:underline">${filters.grades.length===gradeOpts.length?'ì „ì²´í•´ì œ':'ì „ì²´ì„ íƒ'}</button></div>
            <div class="grid grid-cols-5 gap-2">${gradeFilterHTML}</div></div></div>` : `<div class="flex flex-col items-center justify-center rounded-lg p-6 text-center bg-white border">
            <svg class="h-8 w-8 text-slate-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3-7.5 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"/></svg>
            <p class="font-medium text-sm">ë°ì´í„° í•„í„°</p><p class="text-xs text-slate-500 mt-1">ë°ì´í„°ê°€ ë¡œë“œë˜ë©´ í™œì„±í™”ë©ë‹ˆë‹¤.</p></div>`;

        const sidebarSections = [
            { title: 'ğŸ“‹ ëª…ë ¬í‘œ CSV ì—…ë¡œë“œ (í•„ìˆ˜)', content: fileUploadHTML },
            { title: 'ğŸ“Š ì„±ì  ì—‘ì…€ ì—…ë¡œë“œ (ë‚˜ì´ìŠ¤)', content: excelUploadHTML },
            { title: 'âš™ï¸ ë°˜ì˜ ë¹„ìœ¨ ì„¤ì •', content: weightsHTML },
            { title: 'ğŸ“ˆ ë¶„ì„ ì„¤ì •', content: analysisSettingsHTML },
            { title: 'ğŸ” ë™ì  í•„í„°', content: filtersHTML },
        ];
        
        DOMElements.sidebarContent.innerHTML = sidebarSections.map(section => `
            <div class="bg-white p-4 rounded-lg border"><h2 class="text-lg font-semibold text-slate-800 border-b border-slate-200 pb-2 mb-4">${section.title}</h2>${section.content}</div>
        `).join('');

        document.getElementById('file-upload').addEventListener('change', window.handleFileChange);
        setupDropzoneEventListeners();
    }
    
    function renderHeader() {
        const { academicInfo, logoSrc } = state;
        
        // Display academic info as badges (auto-extracted from Excel)
        const infoBadges = [
            { label: 'í•™ë…„ë„', value: academicInfo.year, color: 'indigo' },
            { label: 'í•™ê¸°', value: academicInfo.semester + 'í•™ê¸°', color: 'cyan' },
            { label: 'í•™ë…„', value: academicInfo.grade + 'í•™ë…„', color: 'green' },
            { label: 'ê³¼ëª©', value: academicInfo.subject || '-', color: 'purple' }
        ];

        DOMElements.academicInfoContainer.innerHTML = infoBadges.map(badge => `
            <span class="px-3 py-1 bg-${badge.color}-100 text-${badge.color}-800 rounded-lg text-sm font-medium">
                ${badge.label}: ${badge.value}
            </span>
        `).join('');
        
        DOMElements.logoContainer.innerHTML = `<label for="logo-upload" class="cursor-pointer group flex items-center justify-center">
            <img id="logo-preview" src="${logoSrc || ''}" alt="School Logo" class="${logoSrc ? '' : 'hidden'} h-9 w-auto object-contain" />
            <div id="logo-placeholder" class="${logoSrc ? 'hidden' : ''} h-9 w-24 rounded-md bg-white border flex items-center justify-center ring-1 ring-slate-300 group-hover:ring-indigo-500">
                <span class="text-xs font-semibold text-slate-500 text-center">ë¡œê³  ì—…ë¡œë“œ</span>
            </div>
            <input id="logo-upload" type="file" accept="image/*" class="hidden" />
        </label>`;
        document.getElementById('logo-upload').addEventListener('change', window.handleLogoChange);
    }

    function renderDashboard() {
        const dashboardContainer = DOMElements.dashboardContainer;
        if (state.isProcessing) {
            dashboardContainer.innerHTML = `<div class="flex flex-col justify-center items-center h-full"><div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div><p class="text-lg text-slate-500 mt-4">ë°ì´í„° ë¶„ì„ ì¤‘...</p></div>`;
        } else if (state.analysisError) {
            dashboardContainer.innerHTML = `<div class="flex flex-col justify-center items-center h-full bg-red-50 rounded-xl p-4 text-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="text-xl font-bold text-red-700">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p><p class="text-md text-red-600 mt-2">${state.analysisError}</p><p class="text-sm text-slate-500 mt-4">F12ë¥¼ ëˆŒëŸ¬ ê°œë°œì ë„êµ¬ì˜ 'Console' íƒ­ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p></div>`;
        } else if (state.isReady) {
            const { allStudents, activeStatTab } = state;
            const stats = calculateStats(allStudents, activeStatTab);
            const tabsHTML = CONSTANTS.TABS_ORDER.map(tab => { let isEnabled = false;
            if (tab === 'midterm') {
                isEnabled = state.files.midterm;
            } else if (tab === 'final') {
                isEnabled = state.files.final;
            } else if (tab === 'total') {
                const wts = state.analysisSettings.weights;
                const totWt = (wts.midterm || 0) + (wts.final || 0) + (wts.performance || 0);
                isEnabled = totWt === 100 && allStudents.some(s => s.scores.total !== null);
            } return `<button onclick="window.handleTabChange('${tab}')" class="whitespace-nowrap pb-3 px-1 border-b-2 font-semibold text-base transition-colors ${activeStatTab===tab&&isEnabled?'border-indigo-500 text-indigo-600':'border-transparent text-slate-500 hover:text-slate-800'} ${!isEnabled?'cursor-not-allowed text-slate-300':''}" ${!isEnabled?'disabled':''}>${CONSTANTS.TABS[tab]}</button>`; }).join('');
            const studentsForTable = getFilteredStudents().filter(student => student.scores[activeStatTab] !== null);
            const tableHTML = renderStudentDataTable(getSortedStudents(studentsForTable), allStudents.length);
            
            dashboardContainer.innerHTML = `<div class="space-y-6">
                <div><nav class="flex space-x-8 border-b border-slate-200">${tabsHTML}</nav></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200"><h3 class="font-medium text-slate-500">í‰ê· </h3><p class="text-4xl font-bold mt-1 text-slate-800">${stats.mean.toFixed(2)}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200"><h3 class="font-medium text-slate-500">í‘œì¤€í¸ì°¨</h3><p class="text-4xl font-bold mt-1 text-slate-800">${stats.stdDev.toFixed(2)}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200"><h3 class="font-medium text-slate-500">ì‘ì‹œ ì¸ì›</h3><p class="text-4xl font-bold mt-1 text-slate-800">${stats.count}</p></div>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-5 gap-6">
                    <div id="pie-chart-wrapper" class="xl:col-span-2 bg-white p-6 rounded-xl shadow-md border border-slate-200"><h3 class="text-lg font-semibold mb-4">ë“±ê¸‰/ì„±ì·¨ë„ ë¶„í¬</h3><div class="chart-container"><canvas id="pieChart"></canvas></div></div>
                    <div id="bar-chart-wrapper" class="xl:col-span-3 bg-white p-6 rounded-xl shadow-md border border-slate-200"><h3 class="text-lg font-semibold mb-4">ì ìˆ˜ ë¶„í¬ íˆìŠ¤í† ê·¸ë¨</h3><div class="chart-container"><canvas id="barChart"></canvas></div></div>
                </div>
                ${tableHTML}
            </div>`;
            
            setTimeout(() => { try { renderCharts(); } catch (chartError) {
                console.error("ì°¨íŠ¸ ë Œë”ë§ ì‹¤íŒ¨:", chartError);
                document.getElementById('pie-chart-wrapper').innerHTML = '<div class="flex items-center justify-center h-full text-red-500 p-4">íŒŒì´ ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
                document.getElementById('bar-chart-wrapper').innerHTML = '<div class="flex items-center justify-center h-full text-red-500 p-4">ë§‰ëŒ€ ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
            }}, 0);
        } else {
            dashboardContainer.innerHTML = `<div class="flex flex-col justify-center items-center h-full text-center p-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 text-indigo-400 mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h2 class="text-2xl font-bold text-slate-800 mb-3">ì„±ì  ë¶„ì„ ì‹œì‘í•˜ê¸°</h2>
                <div class="max-w-md space-y-4 text-left">
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <p class="font-semibold text-amber-900 mb-2">1ï¸âƒ£ ëª…ë ¬í‘œ CSV ì—…ë¡œë“œ (í•„ìˆ˜)</p>
                        <p class="text-sm text-amber-800">í•™ìƒ ëª…ë‹¨ì´ í¬í•¨ëœ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="font-semibold text-blue-900 mb-2">2ï¸âƒ£ ë‚˜ì´ìŠ¤ ì—‘ì…€ ì—…ë¡œë“œ</p>
                        <p class="text-sm text-blue-800">ì¤‘ê°„ê³ ì‚¬, ê¸°ë§ê³ ì‚¬, ìˆ˜í–‰í‰ê°€ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.<br>í•™ë…„ë„, í•™ê¸°, í•™ë…„, ê³¼ëª©ì´ ìë™ìœ¼ë¡œ ì¶”ì¶œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                <button onclick="document.getElementById('open-sidebar-btn')?.click()" class="mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition shadow-md">
                    íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘í•˜ê¸°
                </button>
            </div>`;
        }
    }
    
    function renderCharts() {
        if(pieChartInstance) pieChartInstance.destroy(); if(barChartInstance) barChartInstance.destroy();
        const { allStudents, analysisSettings, activeStatTab } = state;
        const pieCanvas = document.getElementById('pieChart'), barCanvas = document.getElementById('barChart');
        if(!pieCanvas || !barCanvas) { console.error("Chart canvas not found"); return; }
        
        const gridColor = 'rgba(0, 0, 0, 0.1)';
        const textColor = '#334155';
        Chart.defaults.color = textColor;

        const distCounts = {}; allStudents.forEach(s => { let k = analysisSettings.gradingSystem === 'relative' ? String(s.grades[activeStatTab]) : s.achievements[activeStatTab]; if (k && k !== 'null' && k !== "0" && k !== "F") { distCounts[k] = (distCounts[k] || 0) + 1; } });
        const distData = Object.entries(distCounts).map(([name, value]) => ({ name, value })).sort((a, b) => a.name === 'ê¸°íƒ€' ? 1 : b.name === 'ê¸°íƒ€' ? -1 : String(a.name).localeCompare(String(b.name), undefined, { numeric: true }));
        if (distData.length > 0) { const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#64748b']; pieChartInstance = new Chart(pieCanvas.getContext('2d'), { type: 'doughnut', data: { labels: distData.map(d => d.name), datasets: [{ data: distData.map(d => d.value), backgroundColor: distData.map((d, i) => d.name === 'I' ? '#ef4444' : colors[i % colors.length]), borderColor: '#ffffff', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: textColor } } } } }); }
        
        // Define the order of bins explicitly to ensure correct sorting on the x-axis
        const binLabels = ['0-9', '10-19', '20-29', '30-39', '40-49', '50-59', '60-69', '70-79', '80-89', '90-99', '100'];
        const bins = {};
        binLabels.forEach(label => bins[label] = 0);
        
        let scoreCount = 0;
        allStudents.forEach(s => {
            const score = s.scores[activeStatTab];
            if (score != null) {
                scoreCount++;
                if (score >= 100) {
                    bins['100']++;
                } else if (score >= 0) {
                    const bin = Math.floor(score / 10) * 10;
                    bins[`${bin}-${bin+9}`]++;
                }
            }
        });
        
        if (scoreCount > 0) {
            barChartInstance = new Chart(barCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: binLabels,
                    datasets: [{
                        label: 'í•™ìƒ ìˆ˜',
                        data: binLabels.map(label => bins[label]), // Map data in the correct order
                        backgroundColor: '#4f46e5',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    }

    function renderStudentDataTable(students, totalCount) {
        const { activeStatTab, sortConfig } = state;
        const cols = {
            total: [{k:'studentId',l:'í•™ë²ˆ'},{k:'name',l:'ì´ë¦„'},{k:'scores.midterm',l:'ì¤‘ê°„'},{k:'scores.final',l:'ê¸°ë§'},{k:'scores.performance',l:'ìˆ˜í–‰'},{k:'scores.total',l:'í•©ê³„'},{k:'ranks.total',l:'ì„ì°¨'},{k:'grades.total',l:'ë“±ê¸‰'},{k:'achievements.total',l:'ì„±ì·¨ë„'}],
            midterm: [{k:'studentId',l:'í•™ë²ˆ'},{k:'name',l:'ì´ë¦„'},{k:'scores.midterm',l:'ì ìˆ˜'},{k:'ranks.midterm',l:'ì„ì°¨'},{k:'grades.midterm',l:'ë“±ê¸‰'},{k:'achievements.midterm',l:'ì„±ì·¨ë„'}],
            final: [{k:'studentId',l:'í•™ë²ˆ'},{k:'name',l:'ì´ë¦„'},{k:'scores.final',l:'ì ìˆ˜'},{k:'ranks.final',l:'ì„ì°¨'},{k:'grades.final',l:'ë“±ê¸‰'},{k:'achievements.final',l:'ì„±ì·¨ë„'}]
        }[activeStatTab];
        if (!cols) return '<div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 text-red-500 text-center">ë°ì´í„° í…Œì´ë¸”ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        
        const sortIcon = (key) => sortConfig?.key === key ? (sortConfig.direction === 'asc' ? `<svg class="w-3 h-3 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 15l7-7 7 7"/></svg>` : `<svg class="w-3 h-3 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"/></svg>`) : `<svg class="w-3 h-3 ml-1 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"/></svg>`;
        const headers = cols.map(c => `<th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider cursor-pointer" onclick="window.handleSort('${c.k}')"><div class="flex items-center">${c.l}${sortIcon(c.k)}</div></th>`).join('');
        const getVal = (o, p) => p.split('.').reduce((a, c) => (a||{})[c], o);
        const rows = students.map(s => `<tr class="hover:bg-slate-50">${cols.map(c => { const v=getVal(s, c.k); const d=typeof v==='number'&&!Number.isInteger(v)?v.toFixed(2):(v??'â€”'); return `<td class="px-4 py-3 whitespace-nowrap text-sm ${(c.k.includes('achievements')&&v==='I')?'text-red-500 font-semibold':''} ${(c.k==='name'||c.k==='studentId')?'font-medium text-slate-900':''}">${d}</td>`; }).join('')}</tr>`).join('');
        
        return `<div class="bg-white rounded-xl shadow-md border border-slate-200"><div class="flex justify-between items-center p-4 border-b border-slate-200"><h3 class="text-lg font-semibold">í•™ìƒ ë°ì´í„° (${students.length}/${totalCount})</h3><button onclick="window.exportToCSV()" class="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white text-sm font-semibold rounded-md hover:bg-indigo-700 transition-colors"><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>CSV ë‚´ë³´ë‚´ê¸°</button></div><div class="overflow-x-auto"><table class="w-full"><thead class="bg-slate-50"><tr>${headers}</tr></thead><tbody class="divide-y divide-slate-200">${students.length>0?rows:`<tr><td colspan="${cols.length}" class="text-center py-16 text-slate-500">í•„í„°ì™€ ì¼ì¹˜í•˜ëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`}</tbody></table></div></div>`;
    }

    // --- EVENT HANDLERS & CORE LOGIC ---
    function setupEventListeners() {
        DOMElements.openSidebarBtn.addEventListener('click', () => toggleSidebar(true));
        DOMElements.closeSidebarBtn.addEventListener('click', () => toggleSidebar(false));
    }
    
    function setupDropzoneEventListeners() {
        const dropzone = document.querySelector('label[for="file-upload"]');
        if (!dropzone) return;
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.add('bg-indigo-50'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.remove('bg-indigo-50'), false);
        });
        dropzone.addEventListener('drop', handleDrop, false);
    }
    
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    function handleDrop(e) { window.handleFileChange({ target: e.dataTransfer }); }

    function toggleSidebar(open) {
        state.isSidebarOpen = open;
        if (open) {
            DOMElements.sidebar.classList.remove('-translate-x-full');
        } else {
            DOMElements.sidebar.classList.add('-translate-x-full');
        }
    }
    
    window.handleFileChange = (event) => {
        const files = event.target.files || event.dataTransfer.files;
        Array.from(files).forEach(f => {
            // Only accept roster file for CSV
            if (f.name.includes('ëª…ë ¬í‘œ')) {
                state.files.roster = f;
            }
        });
        processFilesWithDebounce();
    };
    window.handleLogoChange = (event) => { if (event.target.files && event.target.files[0]) { const r = new FileReader(); r.onload = (e) => { state.logoSrc = e.target.result; render(); }; r.readAsDataURL(event.target.files[0]); }};
    window.handleWeightChange = (exam, value) => { state.analysisSettings.weights[exam] = Math.max(0, Math.min(100, parseInt(value, 10) || 0)); reAnalyzeData(); };
    window.handleSettingsChange = (key, value) => { state.analysisSettings[key] = value; if (key === 'gradingSystem' || key === 'gradeTiers') { state.filters.grades = []; } reAnalyzeData(); };
    window.handleCutoffChange = (level, score) => { const { gradeTiers } = state.analysisSettings; if ((gradeTiers === 9 && level === 'E') || (gradeTiers === 5 && level === 'I')) return; const key = gradeTiers === 9 ? 'achievementCutoffs9Tier' : 'achievementCutoffs5Tier'; state.analysisSettings[key][state.activeStatTab][level] = parseFloat(score) || 0; reAnalyzeData(); };
    window.handleFilterChange = (type, value) => { const set = new Set(state.filters[type]); if (set.has(value)) { set.delete(value); } else { set.add(value); } state.filters[type] = Array.from(set); render(); };
    window.handleSelectAll = (type) => { const { gradeTiers, gradingSystem, achievementCutoffs9Tier, achievementCutoffs5Tier } = state.analysisSettings; const currentCutoffs = gradeTiers === 9 ? achievementCutoffs9Tier[state.activeStatTab] : achievementCutoffs5Tier[state.activeStatTab]; const allVals = type==='classes'?state.classList:gradingSystem==='relative'?(gradeTiers===9?CONSTANTS.GRADES_9_TIER:CONSTANTS.GRADES_5_TIER).map(String):Object.keys(currentCutoffs); state.filters[type] = state.filters[type].length === allVals.length ? [] : allVals; render(); };
    window.handleTabChange = (tab) => { state.activeStatTab = tab; state.sortConfig = { key: `ranks.${tab}`, direction: 'asc' }; render(); };
    window.handleSort = (key) => { let dir = 'asc'; if (state.sortConfig?.key === key && state.sortConfig.direction === 'asc') { dir = 'desc'; } state.sortConfig = { key, direction: dir }; render(); };
    window.exportToCSV = () => { const{academicInfo,activeStatTab}=state;const studentsToExport=getSortedStudents(getFilteredStudents().filter(student=>student.scores[activeStatTab]!==null));const cols={total:[{k:'studentId',l:'í•™ë²ˆ'},{k:'name',l:'ì´ë¦„'},{k:'scores.midterm',l:'ì¤‘ê°„'},{k:'scores.final',l:'ê¸°ë§'},{k:'scores.performance',l:'ìˆ˜í–‰'},{k:'scores.total',l:'í•©ê³„'},{k:'ranks.total',l:'ì„ì°¨'},{k:'grades.total',l:'ë“±ê¸‰'},{k:'achievements.total',l:'ì„±ì·¨ë„'}],midterm:[{k:'studentId',l:'í•™ë²ˆ'},{k:'name',l:'ì´ë¦„'},{k:'scores.midterm',l:'ì ìˆ˜'},{k:'ranks.midterm',l:'ì„ì°¨'},{k:'grades.midterm',l:'ë“±ê¸‰'},{k:'achievements.midterm',l:'ì„±ì·¨ë„'}],final:[{k:'studentId',l:'í•™ë²ˆ'},{k:'name',l:'ì´ë¦„'},{k:'scores.final',l:'ì ìˆ˜'},{k:'ranks.final',l:'ì„ì°¨'},{k:'grades.final',l:'ë“±ê¸‰'},{k:'achievements.final',l:'ì„±ì·¨ë„'}]}[activeStatTab];const info=[`í•™ë…„ë„,${academicInfo.year}`,`í•™ê¸°,${academicInfo.semester}`,`í•™ë…„,${academicInfo.grade}`,`ê³¼ëª©,"${academicInfo.subject||''}"`].join('\n');const headers=cols.map(c=>`"${c.l}"`).join(',');const getVal=(o,p)=>p.split('.').reduce((a,c)=>(a||{})[c],o);const rows=studentsToExport.map(s=>cols.map(c=>{const v=getVal(s,c.k);const f=typeof v==='number'&&!Number.isInteger(v)?v.toFixed(2):(v??'');return `"${String(f).replace(/"/g,'""')}"`;}).join(','));const link=document.createElement("a");link.href=encodeURI("data:text/csv;charset=utf-8,"+'\uFEFF'+info+'\n\n'+headers+'\n'+rows.join('\n'));link.download=`ì„±ì ë¶„ì„_${academicInfo.year}_${academicInfo.semester}í•™ê¸°_${academicInfo.subject||'ê³¼ëª©'}_${activeStatTab}.csv`;link.click();};

    // --- Data Processing (largely unchanged logic) ---
    let debounceTimer;
    function processFilesWithDebounce() { clearTimeout(debounceTimer); debounceTimer = setTimeout(processFiles, 500); }
    async function processFiles() {
        if (!state.files.roster) { return; }
        Object.assign(state, { isProcessing: true, analysisError: null, isReady: false }); render();
        try {
            const fileTexts={};for(const k in state.files){fileTexts[k]=await state.files[k].text();}
            const rosterCSV = parseCSV(fileTexts.roster); if (rosterCSV.length < 2) throw new Error("ëª…ë ¬í‘œ íŒŒì¼ì— í—¤ë”ì™€ í•™ìƒ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            const midtermData=fileTexts.midterm?parseCSV(fileTexts.midterm):[],finalData=fileTexts.final?parseCSV(fileTexts.final):[],performanceData=fileTexts.performance?parseCSV(fileTexts.performance):[];
            const classHeaders=rosterCSV[0],rosterBody=rosterCSV.slice(1);
            const scoreHeaders={midterm:midtermData[0]||null,final:finalData[0]||null,performance:performanceData[0]||null};
            const scoreBodies={midterm:midtermData.slice(1),final:finalData.slice(1),performance:performanceData.slice(1)};
            const classColMap=new Map(); classHeaders.forEach((h,i)=>{if(i>0&&h.trim()&&!isNaN(parseInt(h.trim()))){classColMap.set(h.trim(),i);}});
            if(classColMap.size===0)throw new Error("ëª…ë ¬í‘œ CSV í—¤ë”ì—ì„œ ìˆ«ì í˜•ì‹ì˜ ë°˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            const {grade}=state.academicInfo; const rawStudentData=[],classes=new Set();
            rosterBody.forEach((row,rowIndex)=>{ const studentNum=row[0];if(!studentNum||!studentNum.trim())return; for(const [classNumStr,colIndex] of classColMap.entries()){ const studentName=row[colIndex]; if(studentName&&studentName.trim()){ const className=`${grade}${String(classNumStr).padStart(2,'0')}`; classes.add(className); const findScore=(k)=>{const h=scoreHeaders[k],b=scoreBodies[k];if(!h||!b[rowIndex])return;const i=h.findIndex(x=>x.trim()===classNumStr);return i!==-1?b[rowIndex][i]:undefined;}; rawStudentData.push({studentId:`${className}${String(studentNum).padStart(2,'0')}`,name:studentName.trim(),class:className,number:studentNum.trim(),midtermScore:cleanScore(findScore('midterm')),finalScore:cleanScore(findScore('final')),performanceScore:cleanScore(findScore('performance'))});}}});
            if(rawStudentData.length===0)throw new Error("CSVì—ì„œ í•™ìƒ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.");
            const analyzedStudents = analyzeData(rawStudentData, state.analysisSettings);
            const enabledTabs=[];
            // ë°˜ì˜ë¹„ìœ¨ í•©ì´ ì •í™•íˆ 100%ì¸ì§€ í™•ì¸
            const weights = state.analysisSettings.weights;
            const totalWeight = (weights.midterm || 0) + (weights.final || 0) + (weights.performance || 0);
            const hasTotalScores = totalWeight === 100 && analyzedStudents.some(s => s.scores.total !== null);
            
            // ë°˜ì˜ë¹„ìœ¨ì´ 100%ì´ë©´ 'total'ì„ ìµœìš°ì„ ìœ¼ë¡œ í™œì„±í™”
            if(hasTotalScores) enabledTabs.push('total');
            if(state.files.midterm) enabledTabs.push('midterm');
            if(state.files.final) enabledTabs.push('final');
            if (enabledTabs.length > 0 && !enabledTabs.includes(state.activeStatTab)) { state.activeStatTab = enabledTabs[0]; state.sortConfig = { key: `ranks.${enabledTabs[0]}`, direction: 'asc' }; }
            Object.assign(state,{allStudents:analyzedStudents,classList:Array.from(classes).sort(),isReady:true});
        } catch(error){console.error("CRITICAL ERROR:",error);Object.assign(state,{analysisError:error.message,allStudents:[],classList:[],isReady:false});}
        finally {state.isProcessing = false; render();}
    }
    function reAnalyzeData() { if (state.allStudents.length > 0) { const rawData = state.allStudents.map(s => ({ studentId:s.studentId, name:s.name, class:s.class, number:s.number, midtermScore:s.scores.midterm, finalScore:s.scores.final, performanceScore:s.scores.performance })); state.allStudents = analyzeData(rawData, state.analysisSettings); } render(); }
    function analyzeData(rawData, settings) {
        const studentsWithScores = rawData.map(s => {
            const { midtermScore, finalScore, performanceScore } = s;
            const { weights } = settings;
            let total = null;
            // ë°˜ì˜ë¹„ìœ¨ì´ 100ì´ ë˜ëŠ” ê²½ìš°ë“¤ì— ëŒ€í•´ í•©ì‚°ì ìˆ˜ ê³„ì‚°
            const midTermWeight = weights.midterm || 0;
            const finalWeight = weights.final || 0;
            const perfWeight = weights.performance || 0;
            
            // ëª¨ë‘ ì ìˆ˜ê°€ ìˆëŠ” ê²½ìš° (ë°˜ì˜ë¹„ìœ¨ í•© = 100)
            if (midtermScore !== null && finalScore !== null && performanceScore !== null) { 
                total = (midtermScore * midTermWeight / 100) + (finalScore * finalWeight / 100) + (performanceScore * perfWeight / 100); 
            }
            // ì¤‘ê°„ê³ ì‚¬ì™€ ìˆ˜í–‰í‰ê°€ë§Œ ìˆê³  í•©ì‚°ì´ 100ì¸ ê²½ìš°
            else if (midtermScore !== null && performanceScore !== null && midTermWeight + perfWeight === 100) { 
                total = (midtermScore * midTermWeight / 100) + (performanceScore * perfWeight / 100); 
            }
            // ê¸°ë§ê³ ì‚¬ì™€ ìˆ˜í–‰í‰ê°€ë§Œ ìˆê³  í•©ì‚°ì´ 100ì¸ ê²½ìš°
            else if (finalScore !== null && performanceScore !== null && finalWeight + perfWeight === 100) { 
                total = (finalScore * finalWeight / 100) + (performanceScore * perfWeight / 100); 
            }
            // ì¤‘ê°„ê³ ì‚¬ì™€ ê¸°ë§ê³ ì‚¬ë§Œ ìˆê³  í•©ì‚°ì´ 100ì¸ ê²½ìš°
            else if (midtermScore !== null && finalScore !== null && midTermWeight + finalWeight === 100) { 
                total = (midtermScore * midTermWeight / 100) + (finalScore * finalWeight / 100); 
            }
            return { ...s, scores: { midterm:midtermScore, final:finalScore, performance:performanceScore, total }};
        });
        const calculateMetrics = (scoreKey) => {
            const valid = studentsWithScores.filter(s=>s.scores[scoreKey] !== null).map(s=>({id:s.studentId, score:s.scores[scoreKey]})); if(!valid.length) return {};
            const sorted = [...valid].sort((a,b)=>b.score-a.score);
            let rank = 1;
            for(let i=0; i < sorted.length; i++){ if(i > 0 && sorted[i].score < sorted[i-1].score){ rank = i + 1; } sorted[i].rank = rank; }
            const total = valid.length, tiers=settings.gradeTiers===9?CONSTANTS.GRADE_TIERS_9:CONSTANTS.GRADE_TIERS_5;
            const cutoffs = settings.gradeTiers === 9 ? settings.achievementCutoffs9Tier[scoreKey] : settings.achievementCutoffs5Tier[scoreKey];
            const sortedCutoffs=Object.entries(cutoffs).sort(([,a],[,b])=>b-a), sortedTiers=Object.entries(tiers).sort(([,a],[,b])=>a-b);
            const metrics={};
            for(const s of sorted){ const p=(s.rank/total)*100; let g=null,a='F'; for(const [t,m] of sortedTiers){if(p<=m){g=Number(t);break;}} for(const [l,c] of sortedCutoffs){if(s.score>=c){a=l;break;}} metrics[s.id]={rank:s.rank,grade:g,achievement:a}; }
            return metrics;
        };
        const metrics={midterm:calculateMetrics('midterm'),final:calculateMetrics('final'),total:calculateMetrics('total')};
        return studentsWithScores.map(s=>({...s, ranks:{midterm:metrics.midterm[s.studentId]?.rank??null,final:metrics.final[s.studentId]?.rank??null,total:metrics.total[s.studentId]?.rank??null}, grades:{midterm:metrics.midterm[s.studentId]?.grade??null,final:metrics.final[s.studentId]?.grade??null,total:metrics.total[s.studentId]?.grade??null}, achievements:{midterm:metrics.midterm[s.studentId]?.achievement??null,final:metrics.final[s.studentId]?.achievement??null,total:metrics.total[s.studentId]?.achievement??null}}));
    }
    function getFilteredStudents() { const {allStudents,filters,analysisSettings,activeStatTab}=state; if(!filters.classes.length&&!filters.grades.length)return allStudents; return allStudents.filter(s=>{const c=!filters.classes.length||filters.classes.includes(s.class);if(!c||!filters.grades.length)return c;const g=analysisSettings.gradingSystem==='relative'?String(s.grades[activeStatTab]):s.achievements[activeStatTab];return filters.grades.includes(g);});}
    function getSortedStudents(students) { const {sortConfig}=state; if (!sortConfig || !students.length) return students; const getVal=(o,p)=>p.split('.').reduce((a,c)=>(a||{})[c],o); return [...students].sort((a,b)=>{const aVal=getVal(a,sortConfig.key),bVal=getVal(b,sortConfig.key),aNull=aVal==null,bNull=bVal==null;if(aNull||bNull)return aNull&&bNull?0:aNull?1:-1;const comp=typeof aVal==='string'?aVal.localeCompare(bVal):aVal<bVal?-1:aVal>bVal?1:0;return sortConfig.direction==='asc'?comp:-comp;});}
    function parseCSV(text){if(text.charCodeAt(0)===0xFEFF)text=text.slice(1);const rows=[];let f='',q=!1,r=[];for(let i=0;i<text.length;i++){const c=text[i];if(q){if(c==='"'){if(i+1<text.length&&text[i+1]==='"'){f+='"';i++;}else{q=!1;}}else{f+=c;}}else{if(c==='"'){q=!0;}else if(c===','){r.push(f.trim());f='';}else if(c==='\n'||c==='\r'){if(f||r.length>0){r.push(f.trim());rows.push(r);}r=[];f='';if(c==='\r'&&text[i+1]==='\n'){i++;}}else{f+=c;}}}if(f||r.length>0){r.push(f.trim());rows.push(r);}return rows.filter(r=>r.length>1||(r.length===1&&r[0]));}
    function cleanScore(s){const n=parseFloat(s);return (s==null||String(s).trim()===''||isNaN(n))?null:n;}
    function calculateStats(students, key){if(!students.length)return{mean:0,stdDev:0,count:0};const scores=students.map(s=>s.scores[key]).filter(s=>s!=null&&!isNaN(s));if(!scores.length)return{mean:0,stdDev:0,count:0};const count=scores.length,mean=scores.reduce((a,b)=>a+b,0)/count,stdDev=Math.sqrt(scores.map(x=>Math.pow(x-mean,2)).reduce((a,b)=>a+b,0)/count);return{mean,stdDev,count};}
    
    // ìˆ˜í–‰í‰ê°€ íŒŒì¼ ì¹´ìš´í„° ì¶”ì 
    let performanceFileCounter = 1;
    
    // ë‹¤ìŒ ìˆ˜í–‰í‰ê°€ íŒŒì¼ ë²ˆí˜¸ ê³„ì‚°
    function getNextPerformanceNumber() {
        const existingNumbers = Object.keys(state.excelFiles)
            .filter(key => key.startsWith('performance'))
            .map(key => {
                const num = parseInt(key.replace('performance', ''));
                return isNaN(num) ? 1 : num;
            });
        
        if (existingNumbers.length === 0) {
            return 1;
        }
        
        return Math.max(...existingNumbers) + 1;
    }
    
    // ì—¬ëŸ¬ ìˆ˜í–‰í‰ê°€ íŒŒì¼ì„ í•œ ë²ˆì— ì—…ë¡œë“œ ì²˜ë¦¬
    window.handleMultiplePerformanceFiles = async function(e) {
        const files = e.target.files;
        if (!files || files.length === 0) return;
        
        try {
            state.isProcessing = true;
            render();
            
            let startNumber = getNextPerformanceNumber();
            
            // ê° íŒŒì¼ì„ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                try {
                    const result = await parseExcelFile(file);
                    const { metadata, csvData } = result;
                    
                    // Update academic info from metadata (ì²« íŒŒì¼ì—ì„œë§Œ)
                    if (i === 0) {
                        if (metadata.year) state.academicInfo.year = metadata.year;
                        if (metadata.semester) state.academicInfo.semester = metadata.semester;
                        if (metadata.grade) state.academicInfo.grade = metadata.grade;
                        if (metadata.subject) state.academicInfo.subject = metadata.subject;
                    }
                    
                    // íŒŒì¼ íƒ€ì… ê²°ì •
                    const fileType = (i === 0 && startNumber === 1) ? 'performance' : `performance${startNumber + i}`;
                    
                    // Store Excel file
                    state.excelFiles[fileType] = file;
                    
                    // Convert to CSV File object
                    const csvBlob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                    const csvFile = new File([csvBlob], `${fileType}_parsed.csv`, { type: 'text/csv' });
                    state.files[fileType] = csvFile;
                    
                    console.log(`âœ“ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ: ${fileType} (${file.name})`);
                } catch (fileError) {
                    console.error(`íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ${file.name}`, fileError);
                    alert(`íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${file.name}\n${fileError.message}`);
                }
            }
            
            // ëª¨ë“  íŒŒì¼ì´ ë¡œë“œëœ í›„ í•©ì‚°
            await mergeAndStorePerformanceFiles();
            
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ë‹¤ì‹œ ê°™ì€ íŒŒì¼ì„ ì„ íƒí•  ìˆ˜ ìˆë„ë¡)
            e.target.value = '';
            
            processFilesWithDebounce();
        } catch (error) {
            console.error('Multiple file upload error:', error);
            alert('ì—¬ëŸ¬ íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            state.isProcessing = false;
            render();
        }
    };
    
    // --- Initializer ---
    setupEventListeners();
    
    // --- Excel File Handling ---
    window.handleExcelFileSelect = async function(e, type) {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            state.isProcessing = true;
            render();
            
            const result = await parseExcelFile(file);
            const { metadata, csvData } = result;
            
            // Update academic info from metadata
            if (metadata.year) state.academicInfo.year = metadata.year;
            if (metadata.semester) state.academicInfo.semester = metadata.semester;
            if (metadata.grade) state.academicInfo.grade = metadata.grade;
            if (metadata.subject) state.academicInfo.subject = metadata.subject;
            
            // Store Excel file
            state.excelFiles[type] = file;
            
            // Convert to CSV File object
            const csvBlob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const csvFile = new File([csvBlob], `${type}_parsed.csv`, { type: 'text/csv' });
            state.files[type] = csvFile;  // File ê°ì²´ë¡œ ì €ì¥
            
            // ìˆ˜í–‰í‰ê°€ íŒŒì¼ì¸ ê²½ìš°, ëª¨ë“  ìˆ˜í–‰í‰ê°€ íŒŒì¼ì„ í•©ì‚°
            if (type.startsWith('performance')) {
                await mergeAndStorePerformanceFiles();
            }
            
            processFilesWithDebounce();
        } catch (error) {
            console.error('Excel parsing error:', error);
            alert('ì—‘ì…€ íŒŒì¼ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            state.isProcessing = false;
            render();
        }
    };
    
    // ìˆ˜í–‰í‰ê°€ íŒŒì¼ë“¤ì„ í•©ì‚°í•˜ëŠ” í•¨ìˆ˜
    async function mergeAndStorePerformanceFiles() {
        const performanceKeys = Object.keys(state.files)
            .filter(key => key.startsWith('performance'))
            .sort((a, b) => {
                const numA = parseInt(a.replace('performance', '')) || 0;
                const numB = parseInt(b.replace('performance', '')) || 0;
                return numA - numB;
            });
        
        if (performanceKeys.length === 0) return;
        
        if (performanceKeys.length === 1) {
            // ìˆ˜í–‰í‰ê°€ íŒŒì¼ì´ 1ê°œë©´ ê·¸ëƒ¥ ì‚¬ìš©
            state.files.performance = state.files[performanceKeys[0]];
            return;
        }
        
        // 2ê°œ ì´ìƒì˜ ìˆ˜í–‰í‰ê°€ íŒŒì¼ì„ í•©ì‚°
        try {
            const mergedCsv = await mergePerformanceFiles(performanceKeys);
            const csvBlob = new Blob([mergedCsv], { type: 'text/csv;charset=utf-8;' });
            const csvFile = new File([csvBlob], 'performance_merged.csv', { type: 'text/csv' });
            state.files.performance = csvFile;
        } catch (error) {
            console.error('ìˆ˜í–‰í‰ê°€ í•©ì‚° ì˜¤ë¥˜:', error);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì²« ë²ˆì§¸ íŒŒì¼ë§Œ ì‚¬ìš©
            state.files.performance = state.files[performanceKeys[0]];
        }
    }
    
    // ì—¬ëŸ¬ ìˆ˜í–‰í‰ê°€ íŒŒì¼ì„ í•©ì‚°
    async function mergePerformanceFiles(performanceKeys) {
        // ê° íŒŒì¼ íŒŒì‹±
        const parsedFiles = [];
        
        for (const key of performanceKeys) {
            const csvFile = state.files[key];
            if (!csvFile) continue;
            
            // File ê°ì²´ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
            const csvData = await csvFile.text();
            
            // CSV íŒŒì‹±
            const lines = csvData.trim().split('\n');
            if (lines.length < 2) continue;
            
            // í—¤ë” íŒŒì‹±
            const header = lines[0]
                .split(',')
                .map(h => h.replace(/"/g, '').trim());
            
            // ë°ì´í„° íŒŒì‹±
            const data = {};
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // CSV ì…€ íŒŒì‹±
                const cells = [];
                let cell = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        cells.push(cell.replace(/"/g, '').trim());
                        cell = '';
                    } else {
                        cell += char;
                    }
                }
                cells.push(cell.replace(/"/g, '').trim());
                
                // í•™ìƒ ë²ˆí˜¸
                const studentNum = parseInt(cells[0]);
                if (isNaN(studentNum)) continue;
                
                if (!data[studentNum]) {
                    data[studentNum] = {};
                }
                
                // ê° ë°˜ì˜ ì ìˆ˜ ì¶”ê°€
                for (let j = 1; j < header.length; j++) {
                    const classNum = parseInt(header[j]);
                    const scoreStr = cells[j];
                    
                    if (!isNaN(classNum) && scoreStr !== '') {
                        const score = parseFloat(scoreStr) || 0;
                        if (score > 0) {
                            if (!data[studentNum][classNum]) {
                                data[studentNum][classNum] = 0;
                            }
                            data[studentNum][classNum] += score;
                        }
                    }
                }
            }
            
            parsedFiles.push(data);
        }
        
        if (parsedFiles.length === 0) {
            throw new Error('íŒŒì‹±í•  ìˆ˜í–‰í‰ê°€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        // ëª¨ë“  íŒŒì¼ ë°ì´í„° ë³‘í•©
        const mergedData = {};
        for (const fileData of parsedFiles) {
            for (const [studentNum, scores] of Object.entries(fileData)) {
                const num = parseInt(studentNum);
                if (!mergedData[num]) {
                    mergedData[num] = {};
                }
                
                for (const [classNum, score] of Object.entries(scores)) {
                    const cn = parseInt(classNum);
                    if (!mergedData[num][cn]) {
                        mergedData[num][cn] = 0;
                    }
                    mergedData[num][cn] += score;
                }
            }
        }
        
        // í•©ì‚° ê²°ê³¼ë¥¼ CSVë¡œ ë³€í™˜
        const allClasses = new Set();
        for (const scores of Object.values(mergedData)) {
            for (const classNum of Object.keys(scores)) {
                allClasses.add(parseInt(classNum));
            }
        }
        const sortedClasses = Array.from(allClasses).sort((a, b) => a - b);
        
        // CSV í—¤ë”
        const csvHeader = ['ë²ˆí˜¸ / ë°˜', ...sortedClasses.map(String)];
        const csvLines = [csvHeader.map(h => `"${h}"`).join(',')];
        
        // CSV ë°ì´í„° í–‰
        const sortedStudents = Object.keys(mergedData)
            .map(Number)
            .sort((a, b) => a - b);
        
        for (const studentNum of sortedStudents) {
            const rowData = [studentNum];
            for (const classNum of sortedClasses) {
                const score = mergedData[studentNum][classNum] || '';
                rowData.push(score);
            }
            csvLines.push(rowData.map(cell => `"${cell}"`).join(','));
        }
        
        return csvLines.join('\n');
    }
    
    window.removeExcelFile = function(type) {
        delete state.excelFiles[type];
        delete state.files[type];
        
        // ìˆ˜í–‰í‰ê°€ íŒŒì¼ì„ ì œê±°í–ˆìœ¼ë©´ ë‚˜ë¨¸ì§€ íŒŒì¼ë“¤ì„ ì¬í•©ì‚°
        if (type.startsWith('performance')) {
            const remainingPerformanceKeys = Object.keys(state.files)
                .filter(key => key.startsWith('performance'));
            
            if (remainingPerformanceKeys.length > 0) {
                // ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  í˜¸ì¶œ (debounceë¡œ ì¸í•´ ê³§ processFilesê°€ í˜¸ì¶œë¨)
                mergeAndStorePerformanceFiles();
            } else {
                // ìˆ˜í–‰í‰ê°€ íŒŒì¼ì´ ì—†ìœ¼ë©´ performance íŒŒì¼ë„ ì œê±°
                delete state.files.performance;
            }
        }
        
        processFilesWithDebounce();
    };
    
    async function parseExcelFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // ì „ì²´ ë°ì´í„° ì¶”ì¶œ (ë³‘í•© ì •ë³´ í¬í•¨)
                    const range = XLSX.utils.decode_range(firstSheet['!ref']);
                    
                    // ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (í–‰ 2~7)
                    const metadata = { year: null, semester: null, grade: null, subject: null };
                    for (let row = 1; row <= 6; row++) {
                        for (let col = 0; col <= range.e.c; col++) {
                            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                            const cell = firstSheet[cellRef];
                            if (!cell) continue;
                            
                            const cellValue = cell.v ? String(cell.v) : '';
                            if (!cellValue) continue;
                            
                            const yearMatch = cellValue.match(/(\d{4})í•™ë…„ë„/);
                            const semesterMatch = cellValue.match(/(\d+)í•™ê¸°/);
                            const subjectMatch = cellValue.match(/êµê³¼ëª©\s*:\s*(.+?)(?:\s+ë§Œì |\(|$)/);
                            
                            if (yearMatch) metadata.year = parseInt(yearMatch[1]);
                            if (semesterMatch) metadata.semester = parseInt(semesterMatch[1]);
                            if (subjectMatch) {
                                let subject = subjectMatch[1].trim();
                                if (subject.includes(':')) {
                                    const parts = subject.split(':');
                                    subject = parts[parts.length - 1].trim();
                                }
                                metadata.subject = subject;
                            }
                            
                            // í•™ë…„ ì¶”ì¶œ - "ì£¼ê°„" ì˜¤ë¥¸ìª½ì— ìˆëŠ” í•™ë…„ì„ ìš°ì„ ìœ¼ë¡œ ì°¾ìŒ
                            if (!metadata.grade) {
                                // ë°©ë²•1: "ì£¼ê°„" ë‹¤ìŒì— ë‚˜ì˜¤ëŠ” í•™ë…„ ì°¾ê¸°
                                const gradeAfterWeekMatch = cellValue.match(/ì£¼ê°„\s+(\d+)í•™ë…„/);
                                if (gradeAfterWeekMatch) {
                                    metadata.grade = parseInt(gradeAfterWeekMatch[1]);
                                } else {
                                    // ë°©ë²•2: ë§ˆì§€ë§‰ 3ê¸€ìì—ì„œ "Xí•™ë…„" íŒ¨í„´ ì°¾ê¸°
                                    // (2025í•™ë…„ë„ê°€ ì•„ë‹Œ 2í•™ë…„ë§Œ ì¶”ì¶œí•˜ê¸° ìœ„í•¨)
                                    const lastThreeChars = cellValue.slice(-3);
                                    const gradeMatch = lastThreeChars.match(/(\d+)í•™ë…„/);
                                    if (gradeMatch) {
                                        metadata.grade = parseInt(gradeMatch[1]);
                                    }
                                }
                            }
                        }
                    }
                    
                    // í—¤ë” í–‰ ì°¾ê¸° (ë²ˆí˜¸ê°€ í¬í•¨ëœ ì²« í–‰)
                    let headerRowIdx = -1;
                    for (let row = 0; row < Math.min(20, range.e.r + 1); row++) {
                        let hasHeaderKeyword = false;
                        for (let col = 0; col <= range.e.c; col++) {
                            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                            const cell = firstSheet[cellRef];
                            if (cell && String(cell.v || '').includes('ë²ˆí˜¸')) {
                                hasHeaderKeyword = true;
                                break;
                            }
                        }
                        if (hasHeaderKeyword) {
                            headerRowIdx = row;
                            break;
                        }
                    }
                    
                    if (headerRowIdx === -1) throw new Error('í—¤ë” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    
                    // ë°˜ ë²ˆí˜¸ ì¶”ì¶œ (í—¤ë” í–‰ì—ì„œ ìˆ«ìì¸ ì—´ ì°¾ê¸°)
                    const classMap = new Map();
                    for (let col = 1; col <= range.e.c; col++) {
                        const cellRef = XLSX.utils.encode_cell({r: headerRowIdx, c: col});
                        const cell = firstSheet[cellRef];
                        const cellValue = cell && cell.v ? String(cell.v).trim() : '';
                        if (cellValue && !isNaN(parseInt(cellValue))) {
                            const classNum = parseInt(cellValue);
                            classMap.set(classNum, col);
                        }
                    }
                    
                    // ===== 3ï¸âƒ£ IMPROVED: ë™ì  ë°ì´í„° ë²”ìœ„ ê³„ì‚° ë° ì‘ì‹œì¸ì› íŒŒì‹± =====
                    // [ê°œì„ ì‚¬í•­] í•˜ë“œì½”ë“œëœ '+35' ì œê±°, ì‘ì‹œì¸ì› ëª…ì‹œì  íŒŒì‹±, ë°ì´í„° ê²€ì¦ ì¶”ê°€
                    
                    const students = [];
                    const dataStartRow = headerRowIdx + 1;
                    
                    // 1ï¸âƒ£ ìš”ì•½ í–‰ ìœ„ì¹˜ ì°¾ê¸° (ì‘ì‹œìƒìˆ˜, ì´ì , í‰ê· )
                    let dataEndRow = Math.min(dataStartRow + 35, range.e.r);  // ê¸°ë³¸ê°’
                    let attendanceCount = null;  // ì‘ì‹œì¸ì›
                    let summaryRowStart = null;
                    
                    for (let row = dataStartRow; row <= Math.min(dataStartRow + 40, range.e.r); row++) {
                        const cellRef = XLSX.utils.encode_cell({r: row, c: 1});
                        const cell = firstSheet[cellRef];
                        if (!cell) continue;
                        
                        const cellValue = String(cell.v || '').trim();
                        
                        // ì‘ì‹œìƒìˆ˜ / ì‘ì‹œ í–‰ ê°ì§€
                        if (cellValue.includes('ì‘ì‹œìƒìˆ˜') || 
                            cellValue.includes('ì‘ì‹œ') && !isNaN(parseInt(cellValue.charAt(0)))) {
                            dataEndRow = row - 1;  // ë°ì´í„° ì¢…ë£Œ í–‰ ì„¤ì •
                            summaryRowStart = row;
                            
                            // 2ï¸âƒ£ ì‘ì‹œì¸ì› ìˆ˜ ëª…ì‹œì ìœ¼ë¡œ íŒŒì‹±
                            for (let col = 2; col <= Math.min(4, range.e.c); col++) {
                                const numCellRef = XLSX.utils.encode_cell({r: row, c: col});
                                const numCell = firstSheet[numCellRef];
                                if (numCell && typeof numCell.v === 'number') {
                                    attendanceCount = parseInt(numCell.v);
                                    console.log(`âœ“ ì‘ì‹œì¸ì›: ${attendanceCount}ëª… (${cellValue})`);
                                    break;
                                }
                            }
                            break;
                        }
                    }
                    
                    console.log(`âœ“ íŒŒì‹± ë²”ìœ„: row ${dataStartRow}~${dataEndRow} (Excel: ${dataStartRow + 1}~${dataEndRow + 1}í–‰)`);
                    
                    // 3ï¸âƒ£ í•™ìƒ ì„±ì  ë°ì´í„° ì¶”ì¶œ (ë™ì  ë²”ìœ„ë¡œ)
                    for (let row = dataStartRow; row <= dataEndRow; row++) {
                        // B ì—´(col 1)ì—ì„œ í•™ìƒ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
                        const studentNumCell = firstSheet[XLSX.utils.encode_cell({r: row, c: 1})];
                        if (!studentNumCell || !studentNumCell.v) break;
                        
                        const studentNumStr = String(studentNumCell.v).trim();
                        
                        // ìš”ì•½ í–‰ ì¬í™•ì¸ (ì´ì¤‘ ê²€ì¦)
                        if (isNaN(parseInt(studentNumStr)) || 
                            studentNumStr.includes('ì‘ì‹œ') || 
                            studentNumStr.includes('ì´') || 
                            studentNumStr.includes('í‰ê· ')) {
                            console.log(`â¹ï¸ íŒŒì‹± ì¢…ë£Œ: "${studentNumStr}" (ìš”ì•½ í–‰ ê°ì§€)`);
                            break;
                        }
                        
                        let studentNum;
                        try {
                            studentNum = parseInt(studentNumStr);
                            if (isNaN(studentNum)) break;
                        } catch {
                            break;
                        }
                        
                        const studentData = { number: studentNum, scores: {} };
                        
                        // ê° ë°˜ì˜ ì ìˆ˜ ì¶”ì¶œ
                        classMap.forEach((col, classNum) => {
                            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                            const scoreCell = firstSheet[cellRef];
                            if (scoreCell && scoreCell.v !== null && scoreCell.v !== undefined) {
                                const scoreVal = scoreCell.v;
                                if (typeof scoreVal === 'number') {
                                    studentData.scores[classNum] = scoreVal;
                                } else if (typeof scoreVal === 'string') {
                                    const scoreNum = parseFloat(scoreVal);
                                    if (!isNaN(scoreNum)) {
                                        studentData.scores[classNum] = scoreNum;
                                    }
                                }
                            }
                        });
                        
                        students.push(studentData);
                    }
                    
                    // ===== 4ï¸âƒ£ IMPROVED: ë°ì´í„° ì •í•©ì„± ê²€ì¦ =====
                    console.log(`ğŸ“Š íŒŒì‹±ëœ í•™ìƒ ìˆ˜: ${students.length}ëª…`);
                    
                    if (attendanceCount && students.length !== attendanceCount) {
                        console.warn(`âš ï¸ ê²½ê³ : íŒŒì‹±ëœ í•™ìƒ(${students.length}) â‰  ì‘ì‹œì¸ì›(${attendanceCount})`);
                        console.warn(`   â†’ ì‘ì‹œí•˜ì§€ ì•Šì€ í•™ìƒì´ í¬í•¨ë˜ì—ˆê±°ë‚˜ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    }
                    
                    // ê° í•™ìƒì˜ ì ìˆ˜ ë°ì´í„° ê²€ì¦
                    let incompleteStudents = [];
                    students.forEach(s => {
                        const scoreCount = Object.values(s.scores).filter(
                            v => v !== null && v !== undefined && !isNaN(v)
                        ).length;
                        if (scoreCount === 0) {
                            incompleteStudents.push(s.number);
                        }
                    });
                    
                    if (incompleteStudents.length > 0) {
                        console.warn(`âš ï¸ ì ìˆ˜ ì—†ëŠ” í•™ìƒ: ${incompleteStudents.join(', ')}ë²ˆ`);
                        console.warn(`   â†’ í•´ë‹¹ í•™ìƒë“¤ì€ ì‹œí—˜ì— ì‘ì‹œí•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì„±ì ì´ ë¯¸ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    }
                    
                    // ===== 5ï¸âƒ£ CSV í˜•ì‹ìœ¼ë¡œ ë³€í™˜ =====
                    // CSV í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    const sortedClasses = Array.from(classMap.keys()).sort((a, b) => a - b);
                    const header = ['ë²ˆí˜¸ / ë°˜', ...sortedClasses.map(String)];
                    const csvRows = [header.map(h => `"${h}"`).join(',')];
                    
                    students.forEach(s => {
                        const rowData = [s.number];
                        sortedClasses.forEach(classNum => {
                            const score = s.scores[classNum] ?? '';
                            rowData.push(score);
                        });
                        csvRows.push(rowData.map(cell => `"${cell}"`).join(','));
                    });
                    const csvData = csvRows.join('\n');
                    
                    resolve({ metadata, csvData });
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }


    
    render();
});
</script>
</body>
</html>
